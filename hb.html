<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Authentication System</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>

    <script src="https://www.google.com/recaptcha/enterprise.js?render=6Ldv6CMsAAAAAJex7sdRHHnxxVUKU_C0avMu9Nrk"></script>
    
    <style>
        /* Professional and Animated CSS */
        :root {
            --primary-color: #007bff;
            --secondary-color: #0056b3;
            --background-color: #f8f9fa;
            --text-color: #343a40;
            --error-color: #dc3545;
            --success-color: #28a745;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            width: 100%;
            max-width: 420px;
            margin: 20px;
            padding: 40px;
            background: #ffffff;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            overflow: hidden;
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 25px;
            position: relative;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 600;
            margin-top: 10px;
        }

        button:hover:not(:disabled) {
            background-color: var(--secondary-color);
        }
        
        button:disabled {
            background-color: #adb5bd;
            cursor: not-allowed;
        }

        .message {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .message.show {
             opacity: 1;
        }

        .message.success {
            background-color: #d4edda;
            color: var(--success-color);
        }

        .message.error {
            background-color: #f8d7da;
            color: var(--error-color);
        }

        /* View Animation */
        .auth-view {
            transition: opacity 0.5s, transform 0.5s;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 40px;
            box-sizing: border-box;
            opacity: 0;
            transform: translateX(100%);
            z-index: 1;
        }

        .auth-view.active {
            position: relative;
            opacity: 1;
            transform: translateX(0);
            z-index: 2;
        }
        
        /* Container must wrap the views for absolute positioning */
        .view-wrapper {
            position: relative;
            overflow: hidden;
        }
        
        /* Specific elements */
        #otp-input {
            letter-spacing: 15px;
            text-align: center;
            font-size: 1.5em;
        }
        
        .toggle-link {
            text-align: center;
            margin-top: 15px;
            font-size: 0.9em;
        }
        .toggle-link a {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
        }
        
        #recaptcha-container {
            margin: 20px auto 0 auto;
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="status-message" class="message"></div>

    <div class="view-wrapper">
        <div id="main-view" class="auth-view active">
            <h2>Phone Verification</h2>
            <div class="input-group">
                <label for="check-phone">Mobile Number (10 digits only)</label>
                <input type="text" id="check-phone" placeholder="e.g., 98XXXXXXXX" maxlength="10">
            </div>
            <button id="check-btn">Continue</button>
            <div class="toggle-link">
                <a id="show-forgot-link">Forgot Password?</a>
            </div>
        </div>

        <div id="signup-screen" class="auth-view">
            <h2>Create Account</h2>
            <p>Your number is not registered. Please fill in details.</p>
            <div class="input-group">
                <label for="signup-username">Username</label>
                <input type="text" id="signup-username" placeholder="Enter your full name">
            </div>
            <div class="input-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="Minimum 6 characters">
            </div>
            <button id="signup-send-otp-btn">Sign Up & Verify via OTP</button>
            <div class="toggle-link">
                <a id="back-to-check-signup">Back to Phone Check</a>
            </div>
        </div>

        <div id="login-screen" class="auth-view">
            <h2>Sign In</h2>
            <p>Number: <strong id="login-phone-display"></strong></p>
            <div class="input-group">
                <label for="login-password">Password</label>
                <input type="password" id="login-password" placeholder="Enter your password">
            </div>
            <button id="login-verify-password-btn">Verify Password</button>
            <div class="toggle-link">
                 <a id="show-forgot-link-login">Forgot Password?</a> | <a id="back-to-check-login">Use another number</a>
            </div>
        </div>

        <div id="forgot-screen" class="auth-view">
            <h2>Reset Password</h2>
            <p>Enter your registered mobile number to receive an OTP.</p>
            <div class="input-group">
                <label for="forgot-phone">Mobile Number</label>
                <input type="text" id="forgot-phone" placeholder="10 digits only" maxlength="10">
            </div>
            <button id="forgot-send-otp-btn">Send Reset OTP</button>
            <div class="toggle-link">
                <a id="back-to-check-forgot">Back to Phone Check</a>
            </div>
        </div>
        
        <div id="otp-screen" class="auth-view">
            <h2>Verify OTP</h2>
            <p>A 6-digit code was sent to **<strong id="sent-phone"></strong>**</p>
            <div class="input-group">
                <label for="otp-input">6-Digit Code</label>
                <input type="text" id="otp-input" maxlength="6" placeholder=" _ _ _ _ _ _ ">
            </div>
            <button id="verify-otp-btn">Verify Code</button>
            <p style="font-size: 0.9em; color: #777; margin-top: 15px; text-align: center;">**Note:** Verification happens automatically when 6 digits are entered.</p>
        </div>

        <div id="password-reset-screen" class="auth-view">
            <h2>Set New Password</h2>
            <p>Verification successful. Please set your new password.</p>
            <div class="input-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" placeholder="Minimum 6 characters">
            </div>
            <button id="reset-password-btn">Change Password</button>
        </div>
    </div>
    
    <div id="recaptcha-container"></div>
</div>

<script>
    // PART 2 â€” FIREBASE CONFIG 
    const firebaseConfig = {
      apiKey: "AIzaSyAa66d3C-rJln3tJAtZQBKYTn1WZHk2K3c",
      authDomain: "setmandu-603f9.firebaseapp.com",
      databaseURL: "https://setmandu-603f9-default-rtdb.firebaseio.com",
      projectId: "setmandu-603f9",
      storageBucket: "setmandu-603f9.firebasestorage.app",
      messagingSenderId: "991608006279",
      appId: "1:991608006279:web:0c84a12bdbd72f70ff3a22",
      measurementId: "G-JXTP886QT9"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const database = app.database();

    // --- Global State Variables ---
    let confirmationResult;
    let tempUserData = {};
    let currentMode = ''; // 'signup', 'login', or 'forgot'
    let currentViewId = 'main-view'; // Track current active view

    // --- DOM Elements/View Management ---
    // Defined globally to fix "is not defined" error
    const statusMessage = document.getElementById('status-message');
    const otpInput = document.getElementById('otp-input');
    const sentPhoneText = document.getElementById('sent-phone');
    const allViews = document.querySelectorAll('.auth-view');

    function showMessage(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `message ${type} show`;
        setTimeout(() => {
            statusMessage.classList.remove('show');
        }, 5000);
    }
    
    // Function to handle animated view switching
    function showView(viewId) {
        if (currentViewId === viewId) return;

        // Hide previous view
        const prevView = document.getElementById(currentViewId);
        if (prevView) {
            prevView.classList.remove('active');
        }

        // Show new view
        const nextView = document.getElementById(viewId);
        if (nextView) {
            nextView.classList.add('active');
        }

        currentViewId = viewId;
        statusMessage.classList.remove('show');
    }
    
    function getNepalPhoneNumber(rawPhone) {
        const phone = rawPhone.trim();
        const phoneRegex = /^\d{10}$/;
        if (!phoneRegex.test(phone)) {
            showMessage("Error: Please enter a valid 10-digit Nepali number.", 'error');
            return null;
        }
        return `+977${phone}`;
    }

    // --- 1. reCAPTCHA Initialization (CRITICAL for OTP) ---
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
        'recaptcha-container',
        {
            'size': 'invisible', 
            'callback': (response) => {
                console.log("Invisible reCAPTCHA verified.");
            },
            'expired-callback': () => {
                console.log("reCAPTCHA expired. Resetting.");
                window.recaptchaVerifier.clear();
            }
        }
    );
    window.recaptchaVerifier.render(); 

    // --- 2. Navigation Handlers ---
    document.getElementById('show-forgot-link').addEventListener('click', () => showView('forgot-screen'));
    document.getElementById('show-forgot-link-login').addEventListener('click', () => showView('forgot-screen'));
    document.getElementById('back-to-check-signup').addEventListener('click', () => showView('main-view'));
    document.getElementById('back-to-check-login').addEventListener('click', () => showView('main-view'));
    document.getElementById('back-to-check-forgot').addEventListener('click', () => showView('main-view'));


    // --- 3. User Existence Check ---
    document.getElementById('check-btn').addEventListener('click', async () => {
        const rawPhone = document.getElementById('check-phone').value;
        const fullPhone = getNepalPhoneNumber(rawPhone);
        if (!fullPhone) return;

        document.getElementById('check-btn').disabled = true;
        document.getElementById('check-btn').textContent = 'Checking...';
        showMessage('Checking user status...', 'success');
        
        try {
            const snapshot = await database.ref('users').orderByChild('phone').equalTo(fullPhone).once('value');
            
            tempUserData.phone = fullPhone;
            document.getElementById('login-phone-display').textContent = fullPhone;
            
            if (snapshot.exists()) {
                const uid = Object.keys(snapshot.val())[0];
                const userData = snapshot.val()[uid];
                
                tempUserData.uid = uid;
                tempUserData.dbPassword = userData.password;
                
                showView('login-screen');
                showMessage('Account found. Please enter your password to sign in.', 'success');
                
            } else {
                showView('signup-screen');
                showMessage('New user. Please complete the registration details.', 'success');
            }

        } catch (error) {
            console.error("Check failed:", error);
            showMessage(`Check failed: ${error.message}`, 'error');
        } finally {
             document.getElementById('check-btn').disabled = false;
             document.getElementById('check-btn').textContent = 'Continue';
        }
    });

    // --- 4. Sign Up Flow ---
    document.getElementById('signup-send-otp-btn').addEventListener('click', async () => {
        const username = document.getElementById('signup-username').value.trim();
        const password = document.getElementById('signup-password').value;

        if (!username || password.length < 6) {
            showMessage("Error: Please enter a username and a password of at least 6 characters.", 'error');
            return;
        }

        tempUserData.username = username;
        tempUserData.password = password;
        currentMode = 'signup';
        
        // Pass the signup button to update its state
        sendOTP(tempUserData.phone, document.getElementById('signup-send-otp-btn'));
    });

    // --- 5. Login Flow (Password Verification) ---
    document.getElementById('login-verify-password-btn').addEventListener('click', async () => {
        const inputPassword = document.getElementById('login-password').value;
        const loginBtn = document.getElementById('login-verify-password-btn');

        if (inputPassword !== tempUserData.dbPassword) {
            showMessage("Error: Invalid password. Please try again.", 'error');
            return;
        }

        // Password Matched: Initiate second factor (OTP)
        currentMode = 'login';
        showMessage("Password verified. Sending login OTP...", 'success');
        sendOTP(tempUserData.phone, loginBtn);
    });

    // --- 6. Forgot Password Flow ---
    document.getElementById('forgot-send-otp-btn').addEventListener('click', async () => {
        const rawPhone = document.getElementById('forgot-phone').value;
        const fullPhone = getNepalPhoneNumber(rawPhone);
        if (!fullPhone) return;

        // Check if user exists before sending reset OTP
        const snapshot = await database.ref('users').orderByChild('phone').equalTo(fullPhone).once('value');
        if (!snapshot.exists()) {
            showMessage("Error: This number is not registered.", 'error');
            return;
        }

        tempUserData.phone = fullPhone;
        tempUserData.uid = Object.keys(snapshot.val())[0];
        currentMode = 'forgot';

        sendOTP(fullPhone, document.getElementById('forgot-send-otp-btn'));
    });
    
    // --- 7. CORE OTP SEND FUNCTION (Shared) ---
    async function sendOTP(fullPhoneNumber, buttonElement) {
        buttonElement.disabled = true;
        buttonElement.textContent = 'Sending OTP...';
        showView('otp-screen'); // Move to OTP screen
        sentPhoneText.textContent = fullPhoneNumber;

        try {
            // This implicitly uses the Invisible reCAPTCHA 
            confirmationResult = await auth.signInWithPhoneNumber(fullPhoneNumber, window.recaptchaVerifier);

            showMessage(`OTP successfully sent to ${fullPhoneNumber}.`, 'success');
            
        } catch (error) {
            console.error("OTP Send Error:", error);
            
            let errorMessage = "OTP sending failed. Unknown error.";
            if (error.code === 'auth/invalid-app-credential') {
                errorMessage = "Security verification (reCAPTCHA) failed. Check your Firebase Authorized Domains.";
            } else if (error.code === 'auth/too-many-requests') {
                errorMessage = "Too many requests. Please try again later.";
            }
            
            showMessage(errorMessage, 'error');
            // Go back to the original screen
            const backView = (currentMode === 'forgot' ? 'forgot-screen' : 'main-view');
            showView(backView); 
            
            // CRITICAL: Reset reCAPTCHA on failure
            if (window.recaptchaVerifier) {
                window.recaptchaVerifier.clear();
                window.recaptchaVerifier.render();
            }

        } finally {
            buttonElement.disabled = false;
            buttonElement.textContent = 'Send OTP';
        }
    }

    // --- 8. OTP Verification (Shared) ---
    otpInput.addEventListener('input', () => {
        if (otpInput.value.length === 6) {
            verifyOtp();
        }
    });
    document.getElementById('verify-otp-btn').addEventListener('click', verifyOtp);

    async function verifyOtp() {
        const otpCode = otpInput.value.trim();

        if (otpCode.length !== 6) return;
        
        document.getElementById('verify-otp-btn').disabled = true;
        document.getElementById('verify-otp-btn').textContent = 'Verifying...';
        
        try {
            const result = await confirmationResult.confirm(otpCode);
            const user = result.user; 
            
            if (!user) throw new Error("Verification failed.");

            // Handle success based on current mode
            if (currentMode === 'signup') {
                await saveNewUserToDB(user.uid);
                redirectSuccess("Registration");
            } else if (currentMode === 'login') {
                redirectSuccess("Sign In");
            } else if (currentMode === 'forgot') {
                showView('password-reset-screen');
                showMessage("OTP verified. Please set your new password.", 'success');
            }

        } catch (error) {
            console.error("OTP Verification Error:", error);
            let errorMessage = (error.code === 'auth/invalid-verification-code') ? "Error: Invalid OTP. Check the code." : "Verification failed.";
            showMessage(errorMessage, 'error');
            otpInput.value = '';

        } finally {
            document.getElementById('verify-otp-btn').disabled = false;
            document.getElementById('verify-otp-btn').textContent = 'Verify Code';
        }
    }
    
    // --- 9. Final Actions ---
    async function saveNewUserToDB(uid) {
        const userRef = database.ref('users/' + uid);
        await userRef.set({
            username: tempUserData.username,
            phone: tempUserData.phone,
            password: tempUserData.password 
        });
    }

    function redirectSuccess(action) {
        showMessage(`ðŸŽ‰ ${action} successful! Redirecting to Home Page...`, 'success');
        setTimeout(() => {
            alert(`Welcome! You are now at the Home Page.`);
            // In a real app: window.location.href = 'index.html'; 
        }, 3000);
    }
    
    // --- 10. Password Reset Final Step ---
    document.getElementById('reset-password-btn').addEventListener('click', async () => {
        const newPassword = document.getElementById('new-password').value;
        if (newPassword.length < 6) {
            showMessage("Error: New password must be at least 6 characters.", 'error');
            return;
        }

        const resetBtn = document.getElementById('reset-password-btn');
        resetBtn.disabled = true;
        resetBtn.textContent = 'Changing Password...';

        try {
            // Update password in Realtime Database
            const userRef = database.ref('users/' + tempUserData.uid);
            await userRef.update({
                password: newPassword
            });

            showMessage("âœ… Password successfully changed!", 'success');
            
            setTimeout(() => {
                showView('main-view'); // Back to main check
                document.getElementById('new-password').value = '';
                document.getElementById('forgot-phone').value = '';
            }, 3000);

        } catch (error) {
            console.error("Password Reset Error:", error);
            showMessage(`Password change failed: ${error.message}`, 'error');
        } finally {
            resetBtn.disabled = false;
            resetBtn.textContent = 'Change Password';
        }
    });

</script>

</body>
</html>
