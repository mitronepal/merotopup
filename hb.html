<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ЁЯУ▒ рдиреЗрдкрд╛рд▓ OTP рд╕рд╛рдЗрдирдЕрдк (рдлрд╛рдЗрдирд▓)</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.9.0/firebase-database-compat.js"></script>
    
    <style>
        /* CSS (рд╕реНрдЯрд╛рдЗрд▓рд┐рдВрдЧ) рдкреБрд░рд╛рдиреЛ рдХреЛрдб рдЕрдиреБрд╕рд╛рд░ рдиреИ рдЫ */
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #388E3C;
            --background-color: #f4f7f6;
            --text-color: #333;
            --error-color: #f44336;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--text-color);
        }

        .container {
            width: 100%;
            max-width: 400px;
            margin: 20px;
            padding: 30px;
            background: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.95em;
        }

        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        button {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            font-weight: 600;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        button:active {
            transform: scale(0.99);
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: 500;
            display: none;
        }

        .message.success {
            background-color: #e8f5e9;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
        }

        .message.error {
            background-color: #ffebee;
            color: var(--error-color);
            border: 1px solid var(--error-color);
        }

        #otp-screen {
            display: none;
            text-align: center;
        }

        #otp-input {
            width: 100%;
            letter-spacing: 20px; 
            text-align: center;
            padding: 15px;
            font-size: 1.5em;
            margin-bottom: 20px;
        }

        #recaptcha-container {
            margin: 20px auto 0 auto;
            display: flex;
            justify-content: center;
            transform: scale(0.9);
            transform-origin: center;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="signup-screen">
        <h2>ЁЯУ▒ рдиреЗрдкрд╛рд▓ OTP рджрд░реНрддрд╛</h2>
        <div id="signup-form">
            <div class="input-group">
                <label for="username">рдкреНрд░рдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо (Username)</label>
                <input type="text" id="username" placeholder="рдЖрдлреНрдиреЛ рдирд╛рдо рд░рд╛рдЦреНрдиреБрд╣реЛрд╕реН" required>
            </div>
            <div class="input-group">
                <label for="phone">рдлреЛрди рдирдореНрдмрд░ (рдХрдиреНрдЯреНрд░реА рдХреЛрдб рдмрд┐рдирд╛: репреоXXXXXXXX)</label>
                <input type="text" id="phone" placeholder="резреж рдЕрдВрдХрдХреЛ рдиреЗрдкрд╛рд▓реА рдирдореНрдмрд░ рдорд╛рддреНрд░" maxlength="10" required>
            </div>
            <div class="input-group">
                <label for="password">рдкрд╛рд╕рд╡рд░реНрдб</label>
                <input type="password" id="password" placeholder="рдиреНрдпреВрдирддрдо рем рдЕрдВрдХрдХреЛ" required>
            </div>

            <div id="recaptcha-container"></div>
            
            <button id="send-otp-btn">OTP рдкрдард╛рдЙрдиреБрд╣реЛрд╕реН рд░ рджрд░реНрддрд╛ рдЧрд░реНрдиреБрд╣реЛрд╕реН</button>
        </div>
    </div>

    <div id="otp-screen">
        <h2>ЁЯФС OTP рдкреНрд░рдорд╛рдгрд┐рдд рдЧрд░реНрдиреБрд╣реЛрд╕реН</h2>
        <p>рем-рдЕрдВрдХрдХреЛ рдХреЛрдб **<strong id="sent-phone"></strong>** рдорд╛ рдкрдард╛рдЗрдПрдХреЛ рдЫ</p>
        
        <div class="input-group">
            <label for="otp-input">рем-рдЕрдВрдХрдХреЛ рдХреЛрдб рд╣рд╛рд▓реНрдиреБрд╣реЛрд╕реН</label>
            <input type="text" id="otp-input" maxlength="6" placeholder=" _ _ _ _ _ _ ">
        </div>
        
        <button id="verify-otp-btn" disabled>рдкреНрд░рдорд╛рдгрд┐рдд рдЧрд░реНрдиреБрд╣реЛрд╕реН рд░ рджрд░реНрддрд╛ рдкреВрд░рд╛ рдЧрд░реНрдиреБрд╣реЛрд╕реН</button>
        <p style="font-size: 0.9em; color: #777; margin-top: 15px;">**рдиреЛрдЯ:** рем рдЕрдВрдХрдХреЛ рдХреЛрдб рд╣рд╛рд▓реНрдиреЗ рдмрд┐рддреНрддрд┐рдХреИ рд╕реНрд╡рддрдГ рдкреНрд░рдорд╛рдгрд┐рдд рд╣реБрдиреЗрдЫред</p>
    </div>

    <div id="status-message" class="message"></div>
</div>

<script>
    // PART 2 тАФ FIREBASE CONFIG (рддрдкрд╛рдИрдВрд▓реЗ рджрд┐рдПрдХреЛ рдХрдиреНрдлрд┐рдЧрд░реЗрд╕рди)
    const firebaseConfig = {
      apiKey: "AIzaSyAa66d3C-rJln3tJAtZQBKYTn1WZHk2K3c",
      authDomain: "setmandu-603f9.firebaseapp.com",
      databaseURL: "https://setmandu-603f9-default-rtdb.firebaseio.com",
      projectId: "setmandu-603f9",
      storageBucket: "setmandu-603f9.firebasestorage.app",
      messagingSenderId: "991608006279",
      appId: "1:991608006279:web:0c84a12bdbd72f70ff3a22",
      measurementId: "G-JXTP886QT9"
    };

    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = app.auth();
    const database = app.database();

    // DOM Elements
    const signupScreen = document.getElementById('signup-screen');
    const otpScreen = document.getElementById('otp-screen');
    const statusMessage = document.getElementById('status-message');
    const sendOtpBtn = document.getElementById('send-otp-btn');
    const verifyOtpBtn = document.getElementById('verify-otp-btn');
    const phoneInput = document.getElementById('phone');
    const otpInput = document.getElementById('otp-input');
    const sentPhoneText = document.getElementById('sent-phone');
    
    // Global variables
    let confirmationResult;
    let tempUsername = '';
    let tempPhone = '';
    let tempPassword = '';

    // --- Utility Functions ---

    function showMessage(message, type) {
        statusMessage.textContent = message;
        statusMessage.className = `message ${type}`;
        statusMessage.style.display = 'block';
        setTimeout(() => {
            statusMessage.style.display = 'none';
        }, 6000);
    }
    
    function validateInput() {
        tempUsername = document.getElementById('username').value.trim();
        const rawPhone = phoneInput.value.trim();
        tempPassword = document.getElementById('password').value;

        if (!tempUsername || !rawPhone || !tempPassword) {
            showMessage("рд╕рдмреИ рдлрд┐рд▓реНрдбрд╣рд░реВ рдЕрдирд┐рд╡рд╛рд░реНрдп рдЫрдиреНред", 'error');
            return false;
        }

        // Nepali 10-digit number check (without country code)
        const phoneRegex = /^\d{10}$/;
        if (!phoneRegex.test(rawPhone)) {
            showMessage("рдХреГрдкрдпрд╛ резреж рдЕрдВрдХрдХреЛ рдиреЗрдкрд╛рд▓реА рдирдореНрдмрд░ рдорд╛рддреНрд░ рд╣рд╛рд▓реНрдиреБрд╣реЛрд╕реН (рдХреЛрдб рдмрд┐рдирд╛)ред", 'error');
            return false;
        }

        if (tempPassword.length < 6) {
            showMessage("рдкрд╛рд╕рд╡рд░реНрдб рдХрдореНрддрд┐рдорд╛ рем рдЕрдХреНрд╖рд░рдХреЛ рд╣реБрдиреБрдкрд░реНрдЫред", 'error');
            return false;
        }
        
        // CRITICAL FIX: Add the country code +977 internally
        tempPhone = `+977${rawPhone}`;
        return true;
    }

    // --- Firebase Initialization & Handlers ---

    /**
     * 1. Initializes RecaptchaVerifier using the CORRECT NAMESPACED structure.
     */
    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(
        'recaptcha-container',
        {
            'size': 'normal',
            'callback': (response) => {
                console.log("reCAPTCHA рдкреНрд░рдорд╛рдгрд┐рдд рднрдпреЛред");
            },
            'expired-callback': () => {
                showMessage("reCAPTCHA рдХреЛ рд╕рдордп рд╕рдХрд┐рдпреЛред рдХреГрдкрдпрд╛ рдкреБрди: рдкреНрд░рдпрд╛рд╕ рдЧрд░реНрдиреБрд╣реЛрд╕реНред", 'error');
                window.recaptchaVerifier.clear();
                window.recaptchaVerifier.render(); 
            }
        }
    );
    window.recaptchaVerifier.render();


    /**
     * 2. Handles sending the OTP via signInWithPhoneNumber.
     */
    sendOtpBtn.addEventListener('click', async () => {
        if (!validateInput()) {
            return;
        }

        sendOtpBtn.disabled = true;
        sendOtpBtn.textContent = 'OTP рдкрдард╛рдЙрдБрджреИ...';
        statusMessage.style.display = 'none';

        try {
            // Use the internally generated +977 phone number
            confirmationResult = await auth.signInWithPhoneNumber(tempPhone, window.recaptchaVerifier);

            // Success: Move to OTP screen
            showMessage(`OTP рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ ${tempPhone} рдорд╛ рдкрдард╛рдЗрдПрдХреЛ рдЫред рдХреГрдкрдпрд╛ рдХреЛрдб рд╣рд╛рд▓реНрдиреБрд╣реЛрд╕реНред`, 'success');
            sentPhoneText.textContent = tempPhone;
            signupScreen.style.display = 'none';
            otpScreen.style.display = 'block';
            otpInput.focus();

        } catch (error) {
            console.error("OTP рдкрдард╛рдЙрдБрджрд╛ рддреНрд░реБрдЯрд┐:", error);
            
            let errorMessage = "OTP рдкрдард╛рдЙрдБрджрд╛ рдЕрдЬреНрдЮрд╛рдд рддреНрд░реБрдЯрд┐ рднрдпреЛред";

            if (error.code === 'auth/invalid-phone-number') {
                errorMessage = "рдЕрдорд╛рдиреНрдп рдлреЛрди рдирдореНрдмрд░ (рдЕрдЯреЛ-рдХреЛрдб +977 рд╕рд╣рд┐рдд)ред";
            } else if (error.code === 'auth/invalid-app-credential') {
                errorMessage = "рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рдорд╛рдгрд┐рдХрд░рдг (reCAPTCHA) рдЕрд╕рдлрд▓ рднрдпреЛред рдХреГрдкрдпрд╛ рдкреЗрдЬ рд░рд┐рдлреНрд░реЗрд╕ рдЧрд░реА рдлреЗрд░рд┐ рдкреНрд░рдпрд╛рд╕ рдЧрд░реНрдиреБрд╣реЛрд╕реНред";
            } else {
                errorMessage = `рддреНрд░реБрдЯрд┐: ${error.message}`;
            }

            showMessage(errorMessage, 'error');

            // CRITICAL FIX: Always reset reCAPTCHA on failure
            if (window.recaptchaVerifier) {
                window.recaptchaVerifier.clear();
                window.recaptchaVerifier.render();
            }

        } finally {
            sendOtpBtn.disabled = false;
            sendOtpBtn.textContent = 'OTP рдкрдард╛рдЙрдиреБрд╣реЛрд╕реН рд░ рджрд░реНрддрд╛ рдЧрд░реНрдиреБрд╣реЛрд╕реН';
        }
    });

    /**
     * 3. Auto-Verify OTP when 6 digits are entered.
     */
    otpInput.addEventListener('input', () => {
        if (otpInput.value.length === 6) {
            verifyOtp();
        }
    });

    // Fallback for button click (though auto-verify is faster)
    verifyOtpBtn.addEventListener('click', verifyOtp); 

    async function verifyOtp() {
        const otpCode = otpInput.value.trim();

        if (otpCode.length !== 6) {
            return; // Wait for full 6 digits
        }

        verifyOtpBtn.disabled = true;
        verifyOtpBtn.textContent = 'рдкреНрд░рдорд╛рдгрд┐рдд рдЧрд░реНрджреИ...';
        
        try {
            const result = await confirmationResult.confirm(otpCode);
            const user = result.user; 

            if (user) {
                const uid = user.uid;
                const userRef = database.ref('users/' + uid);
                
                await userRef.set({
                    username: tempUsername,
                    phone: tempPhone,
                    password: tempPassword 
                });

                // Success message and "redirect"
                showMessage("ЁЯОЙ рджрд░реНрддрд╛ рд╕рдлрд▓ рднрдпреЛ! рддрдкрд╛рдИрдВрдХреЛ рдЦрд╛рддрд╛ рдмрдиреНрдпреЛ рд░ DB рдорд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдЧрд░рд┐рдпреЛред", 'success');
                setTimeout(() => {
                    alert(`рд╕реНрд╡рд╛рдЧрдд рдЫ, ${tempUsername}! рддрдкрд╛рдИрдВ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рд▓рдЧ-рдЗрди рд╣реБрдиреБрднрдПрдХреЛ рдЫред`);
                }, 3000);

            }

        } catch (error) {
            console.error("OTP рдкреНрд░рдорд╛рдгрд┐рдд рдЧрд░реНрджрд╛ рддреНрд░реБрдЯрд┐:", error);
            
            let errorMessage = "OTP рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЕрд╕рдлрд▓ рднрдпреЛред";

            if (error.code === 'auth/invalid-verification-code') {
                errorMessage = "рдЕрдорд╛рдиреНрдп OTPред рдХреГрдкрдпрд╛ рдХреЛрдб рдЬрд╛рдБрдЪ рдЧрд░реНрдиреБрд╣реЛрд╕реНред";
            } else if (error.code === 'auth/code-expired') {
                errorMessage = "рдХреЛрдбрдХреЛ рд╕рдордп рд╕рдХрд┐рдПрдХреЛ рдЫред рдХреГрдкрдпрд╛ рдкрдЫрд╛рдбрд┐ рдЧрдПрд░ OTP рдкреБрди: рдкрдард╛рдЙрдиреБрд╣реЛрд╕реНред";
            } else {
                errorMessage = `рдкреНрд░рдорд╛рдгреАрдХрд░рдг рддреНрд░реБрдЯрд┐: ${error.message}`;
            }

            showMessage(errorMessage, 'error');
            otpInput.value = ''; // Clear input for re-entry

        } finally {
            verifyOtpBtn.disabled = false;
            verifyOtpBtn.textContent = 'рдкреНрд░рдорд╛рдгрд┐рдд рдЧрд░реНрдиреБрд╣реЛрд╕реН рд░ рджрд░реНрддрд╛ рдкреВрд░рд╛ рдЧрд░реНрдиреБрд╣реЛрд╕реН';
        }
    }

</script>

</body>
</html>
