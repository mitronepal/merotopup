<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mero Topup</title>

    <!-- ðŸ”µðŸ”µ SOCIAL SHARE PREVIEW / OPENGRAPH TAGS (Facebook, WhatsApp, Instagram, Viber) -->
    <meta property="og:title" content="Mero Topup â€” Nepal ko Best Gaming Topup Service">
    <meta property="og:description" content="Fast â€¢ Secure â€¢ Instant | Free Fire, PUBG, MLBB, Roblox Topup Now!">
    <meta property="og:image" content="profile.jpg">  
    <meta property="og:url" content="https://mitronepal.github.io/merotopup">
    <meta property="og:type" content="website">

    <!-- ðŸŸ£ TWITTER CARD PREVIEW (Twitter / X) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Mero Topup â€” Nepal ko No.1 Gaming Topup">
    <meta name="twitter:description" content="Affordable â€¢ Trusted â€¢ Instant Delivery">
    <meta name="twitter:image" content="Profile.jpg">

    <!-- ðŸŸ¡ SEO / GOOGLE SEARCH OPTIMIZATION -->
    <meta name="description" content="Nepal's fastest and cheapest Free Fire, PUBG, MLBB, and gaming topup website.">
    <meta name="keywords" content="free fire topup, pubg topup, mlbb diamond, nepal topup, mero topup">
    <meta name="author" content="Mero Topup">

    <!-- FAVICON -->
    <link rel="icon" type="image/png" href="Profile.jpg">

    <!-- CSS / Font Import -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.0.0/firebase-storage.js"></script>

    <!-- QRCode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --primary-color: #5F5FF5;
            --primary-light: #8A8AFF;
            --primary-dark: #272E48;
            --nav-bg: #1B233A;
            --surface-bg: #ffffff;
            --app-bg: #F8F9FD;
            --text-primary: #1A1A1A;
            --text-secondary: #666666;
            --text-light: #ffffff;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #F44336;
            --gradient-primary: linear-gradient(135deg, #5F5FF5 0%, #8A8AFF 100%);
            --gradient-dark: linear-gradient(135deg, #1B233A 0%, #272E48 100%);
            --md-radius: 16px;
            --lg-radius: 24px;
            --sm-radius: 8px;
            --card-shadow: 0 8px 24px rgba(0,0,0,0.08);
            --floating-shadow: 0 12px 28px rgba(0,0,0,0.15);
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--app-bg);
            color: var(--text-primary);
            overflow-x: hidden;
            line-height: 1.6;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background-color: var(--surface-bg);
            min-height: 100vh;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.06);
            overflow-x: hidden;
            padding-bottom: 80px;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 1200px;
                box-shadow: 0 0 40px rgba(0,0,0,0.08);
                border-radius: 20px;
                margin: 20px auto;
                min-height: calc(100vh - 40px);
            }
            
            .main-content {
                padding: 100px 30px 30px; 
                display: grid;
                grid-template-columns: 1fr 2fr;
                gap: 30px;
            }
            
            .balance-card {
                grid-column: 1 / 2;
                height: min-content;
            }

            .quick-actions {
                grid-column: 1 / 2;
                flex-wrap: wrap;
                justify-content: space-between;
                padding: 0;
            }

            .action-item {
                width: 48%;
                margin-bottom: 10px;
            }
            
            .product-grid {
                grid-template-columns: repeat(3, 1fr); 
                grid-column: 2 / 3;
            }
            
            #page-payment .main-content {
                grid-template-columns: 1fr 1fr;
                gap: 30px;
            }
            
            .payment-methods {
                grid-column: 1 / 2;
                display: block;
                padding: 0;
            }
            
            .form-section {
                grid-column: 2 / 3;
                margin: 0;
                height: min-content;
            }
            
            .bottom-nav-container {
                display: none;
            }
            
            .header {
                max-width: 1200px;
                padding: 15px 30px;
                left: 50%;
                transform: translateX(-50%);
            }

            #page-profile .main-content {
                grid-template-columns: 1fr 1fr;
            }

            #page-order .main-content {
                grid-template-columns: 1fr;
            }

            .order-card {
                width: 100%;
                max-width: 800px;
                margin: 16px auto;
            }
            
            #page-home .section-title:nth-of-type(2) {
                grid-column: 1 / -1;
            }
            #page-home .product-grid:nth-of-type(2) {
                grid-column: 1 / -1;
                grid-template-columns: repeat(6, 1fr);
                max-width: 100%;
            }
            #page-home .product-grid:nth-of-type(2) .product-card {
                max-width: none;
            }
            #page-home .section-title:nth-of-type(1) {
                grid-column: 2 / 3;
            }
            #page-home .product-grid:nth-of-type(1) {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .main-content > div:last-child {
                grid-column: 1 / -1; 
            }
        }
        
        .reseller-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 2000;
            padding: 16px;
        }

        .reseller-dialog-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .reseller-dialog-card {
            background: white;
            border-radius: 20px;
            max-width: 380px;
            width: 100%;
            overflow: hidden;
            box-shadow: var(--floating-shadow);
            position: relative;
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .reseller-dialog-overlay.active .reseller-dialog-card {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .reseller-dialog-header {
            padding: 24px 20px 18px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .reseller-dialog-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .reseller-dialog-header h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }

        .reseller-dialog-subtitle {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .reseller-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            backdrop-filter: blur(10px);
            border: none;
            color: white;
        }

        .reseller-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .reseller-dialog-body {
            padding: 24px 20px;
            text-align: center;
        }

        .reseller-dialog-body p {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .reseller-dialog-body strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        .reseller-features-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 24px;
        }

        .reseller-feature-item {
            display: flex;
            align-items: center;
            padding: 12px 14px;
            background: var(--app-bg);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .reseller-feature-item:hover {
            transform: translateX(3px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .reseller-feature-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }

        .reseller-feature-text {
            text-align: left;
            flex: 1;
            font-size: 14px;
            font-weight: 500;
        }

        .reseller-dialog-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .reseller-btn-primary {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .reseller-btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }

        .reseller-btn-primary:hover::before {
            left: 100%;
        }

        .reseller-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(95, 95, 245, 0.4);
        }

        .reseller-btn-secondary {
            flex: 1;
            padding: 14px;
            background: var(--app-bg);
            color: var(--primary-color);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reseller-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            background: white;
        }

        @media (max-width: 480px) {
            .reseller-dialog-card {
                max-width: 100%;
            }
            
            .reseller-dialog-actions {
                flex-direction: column;
            }
            
            .reseller-btn-primary, .reseller-btn-secondary {
                width: 100%;
            }
            
            .reseller-feature-item {
                padding: 10px 12px;
            }
            
            .reseller-feature-icon {
                width: 28px;
                height: 28px;
                font-size: 12px;
                margin-right: 10px;
            }
            
            .reseller-feature-text {
                font-size: 13px;
            }
        }

        @media (max-width: 360px) {
            .reseller-dialog-header {
                padding: 20px 16px 16px;
            }
            
            .reseller-dialog-body {
                padding: 20px 16px;
            }
            
            .reseller-dialog-icon {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            
            .reseller-dialog-header h2 {
                font-size: 20px;
            }
            
            .reseller-dialog-subtitle {
                font-size: 13px;
            }
            
            .reseller-features-list {
                gap: 10px;
            }
        }

        .confirmation-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 2500;
            padding: 16px;
        }

        .confirmation-dialog-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .confirmation-dialog-card {
            background: white;
            border-radius: 20px;
            max-width: 380px;
            width: 100%;
            overflow: hidden;
            box-shadow: var(--floating-shadow);
            position: relative;
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .confirmation-dialog-overlay.active .confirmation-dialog-card {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .confirmation-dialog-header {
            padding: 24px 20px 18px;
            background: linear-gradient(135deg, var(--warning-color), #FFB74D);
            color: white;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .confirmation-dialog-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 12px;
            font-size: 24px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .confirmation-dialog-header h2 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }

        .confirmation-dialog-subtitle {
            font-size: 14px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .confirmation-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
            backdrop-filter: blur(10px);
            border: none;
            color: white;
        }

        .confirmation-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .confirmation-dialog-body {
            padding: 24px 20px;
            text-align: center;
        }

        .confirmation-dialog-body p {
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .confirmation-dialog-body strong {
            color: var(--primary-color);
            font-weight: 600;
        }

        .confirmation-dialog-body .highlight {
            color: var(--danger-color);
            font-weight: 700;
        }

        .confirmation-dialog-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirmation-btn-primary {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, var(--success-color), #66BB6A);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirmation-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }

        .confirmation-btn-secondary {
            flex: 1;
            padding: 14px;
            background: var(--app-bg);
            color: var(--text-secondary);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirmation-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .confirmation-btn-danger {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, var(--danger-color), #EF5350);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .confirmation-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
        }

        .auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 5000;
            display: none; 
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .auth-modal-overlay.visible {
            display: flex;
            opacity: 1;
        }

        .auth-container {
            background: #fff;
            width: 90%;
            max-width: 420px;
            border-radius: 18px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            position: relative; 
            transform: scale(0.9);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .auth-modal-overlay.visible .auth-container {
             transform: scale(1);
        }
        
        .auth-form-wrapper {
            padding: 30px 25px;
            display: none; 
            flex-direction: column;
            align-items: center;
            transition: all 0.4s ease;
            width: 100%;
        }
        .auth-form-wrapper.active {
            display: flex;
        }
        .title {
            font-size: 26px;
            font-weight: 600;
            color: var(--primary-dark);
            margin-bottom: 8px;
            text-align: center;
        }
        .subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 25px;
            text-align: center;
        }
        .avatar-container {
            position: relative;
            width: 100px;
            height: 100px;
            background: #E5E7FF;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--primary-color);
            font-size: 36px;
            cursor: pointer;
            margin-bottom: 20px;
            overflow: hidden;
            transition: 0.3s;
        }
        .avatar-container img { width: 100%; height: 100%; object-fit: cover; }
        #auth-avatar-input { display: none; }
        
        .input-field {
            position: relative;
            width: 100%;
            margin-bottom: 18px;
        }
        .input-field input {
            width: 100%;
            padding: 14px 12px 14px 40px;
            border: 1.8px solid #E0E0E0;
            border-radius: 10px;
            outline: none;
            font-size: 15px;
            transition: all 0.3s ease;
        }
        .input-field input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 5px rgba(95, 95, 245, 0.3);
        }
        .input-field .material-icons {
            position: absolute;
            top: 12px;
            left: 10px;
            color: #B0B0B0;
        }
        .action-btn {
            width: 100%;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 10px;
            height: 45px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 5px;
        }
        .action-btn:hover {
            background: #4747f0;
            box-shadow: 0 4px 12px rgba(95, 95, 245, 0.3);
        }
        .bottom-text {
            margin-top: 15px;
            font-size: 13px;
            color: #555;
            text-align: center;
        }
        .bottom-text a {
            color: var(--primary-color);
            font-weight: 600;
            text-decoration: none;
            margin-left: 5px;
        }
        .bottom-text a:hover { text-decoration: underline; }
        .forgot-link {
            align-self: flex-end;
            margin-bottom: 15px;
        }
        .forgot-link a {
            font-size: 12px;
            color: var(--primary-color);
            font-weight: 600; 
            text-decoration: none;
            cursor: pointer;
        }
        .forgot-link a:hover { text-decoration: underline; }
        .lang-select {
            margin-top: 10px;
            font-size: 13px;
            color: #555;
        }
        .lang-select select {
            border: none;
            background: transparent;
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
        }

        #forgot-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; 
            justify-content: center;
            align-items: center;
            z-index: 6000;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        .modal-content h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        .modal-content .input-field {
            margin-bottom: 15px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-actions button {
            flex: 1;
            height: 40px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        #reset-cancel-btn {
            background: #ccc;
            color: #333;
        }
        #reset-send-btn {
            background: var(--primary-color);
            color: white;
        }

        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            margin-bottom: 10px;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateX(100%);
            display: flex;
            align-items: center;
            min-width: 250px;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.info { background-color: #2196F3; }
        .toast .material-icons { margin-right: 10px; }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--surface-bg);
            color: var(--text-primary);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            max-width: 480px;
            margin: 0 auto;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: transform 0.3s ease;
        }

        .header.hidden {
            transform: translateY(-100%);
        }

        .header-left { display: flex; align-items: center; }
        .header-icon { width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 12px; background-color: rgba(95, 95, 245, 0.1); cursor: pointer; color: var(--primary-color); transition: var(--transition); }
        .header-icon:hover { background-color: rgba(95, 95, 245, 0.2); transform: scale(1.05); }
        .header-title { font-size: 18px; font-weight: 600; margin-left: 12px; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .notification-badge { 
            position: relative; 
            display: none;
        }
        .notification-badge::after { 
            content: ''; 
            position: absolute; 
            top: -2px; 
            right: -2px; 
            width: 8px; 
            height: 8px; 
            background-color: var(--danger-color); 
            border-radius: 50%; 
            border: 2px solid var(--surface-bg); 
        }
        .notification-badge.has-unread {
            display: block;
        }
        .header-notification-icon { width: 28px; height: 28px; font-size: 20px; color: var(--text-secondary); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: var(--transition); }
        .header-notification-icon:hover { color: var(--primary-color); transform: scale(1.1); }
        .header-profile-image { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid rgba(95, 95, 245, 0.2); cursor: pointer; transition: var(--transition); }
        .header-profile-image:hover { border-color: var(--primary-color); transform: scale(1.05); }
        .main-content { padding: 80px 16px 20px; background-color: var(--app-bg); min-height: calc(100vh - 80px); }
        .balance-card { background: var(--gradient-primary); color: var(--text-light); border-radius: var(--lg-radius); padding: 20px; box-shadow: var(--card-shadow); margin-bottom: 20px; position: relative; overflow: hidden; }
        .balance-card::before { content: ''; position: absolute; top: -50%; right: -50%; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.1); transform: rotate(30deg); }
        .balance-title { font-size: 14px; font-weight: 500; margin-bottom: 8px; opacity: 0.9; }
        .balance-amount { display: flex; align-items: center; margin-bottom: 16px; }
        .amount { font-size: 28px; font-weight: 700; margin-right: 8px; }
        .currency { font-size: 20px; font-weight: 600; margin-right: 12px; }
        .visibility-icon { margin-right: 12px; opacity: 0.8; cursor: pointer; transition: var(--transition); }
        .visibility-icon:hover { opacity: 1; transform: scale(1.1); }
        .add-balance-btn { background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); color: var(--text-light); padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; margin-left: auto; font-size: 14px; border: 1px solid rgba(255, 255, 255, 0.3); transition: var(--transition); }
        .add-balance-btn:hover { background-color: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
        .account-info { display: flex; align-items: center; padding-top: 12px; border-top: 1px solid rgba(255, 255, 255, 0.2); }
        .account-text { font-weight: 500; flex-grow: 1; font-size: 14px; opacity: 0.9; }
        .copy-icon { opacity: 0.8; font-size: 18px; cursor: pointer; transition: var(--transition); }
        .copy-icon:hover { opacity: 1; transform: scale(1.1); }
        .quick-actions { display: flex; justify-content: space-between; margin: 20px 0; padding: 0 8px; }
        .action-item { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: var(--transition); padding: 8px; border-radius: var(--md-radius); }
        .action-item:hover { background-color: rgba(95, 95, 245, 0.05); transform: translateY(-5px); }
        .action-icon { width: 56px; height: 56px; background: var(--surface-bg); border-radius: 18px; box-shadow: var(--card-shadow); display: flex; align-items: center; justify-content: center; margin-bottom: 8px; transition: var(--transition); }
        .action-icon i { font-size: 24px; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .action-name { font-size: 12px; font-weight: 500; color: var(--text-secondary); }
        .section-title { font-size: 18px; font-weight: 600; margin: 24px 0 16px 0; color: var(--text-primary); display: flex; align-items: center; }
        .section-title::after { content: ''; flex-grow: 1; height: 1px; background: linear-gradient(to right, var(--primary-color), transparent); margin-left: 12px; }
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .product-card { background-color: var(--surface-bg); border-radius: var(--md-radius); overflow: hidden; box-shadow: var(--card-shadow); cursor: pointer; transition: var(--transition); position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: var(--floating-shadow); }
        .product-image { height: 120px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #EEF0FF 0%, #F0F2FF 100%); position: relative; overflow: hidden; }
        .product-image::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--gradient-primary); opacity: 0; transition: var(--transition); }
        .product-card:hover .product-image::before { opacity: 0.1; }
        .product-image i { font-size: 40px; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; z-index: 1; transition: var(--transition); }
        .product-card:hover .product-image i { transform: scale(1.1); }
        .product-name { text-align: center; padding: 12px 8px; font-size: 14px; font-weight: 600; color: var(--text-primary); }
        .payment-methods { padding: 0 16px 16px 16px; }
        .payment-title { text-align: center; font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 24px; position: relative; }
        .payment-title::after { content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 60px; height: 3px; background: var(--gradient-primary); border-radius: 2px; }
        .payment-item { display: flex; align-items: center; background-color: var(--surface-bg); padding: 16px; margin: 16px 0; border-radius: var(--md-radius); box-shadow: var(--card-shadow); transition: var(--transition); cursor: pointer; border: 2px solid transparent; }
        .payment-item:hover { transform: translateY(-3px); box-shadow: var(--floating-shadow); }
        .payment-item.selected { border-color: var(--primary-color); background-color: rgba(95, 95, 245, 0.05); box-shadow: 0 0 0 4px rgba(95, 95, 245, 0.1); }
        .payment-logo { width: 60px; height: 60px; padding: 12px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 24px; margin-right: 16px; transition: var(--transition); }
        .payment-item:hover .payment-logo { transform: scale(1.1); }
        .khalti-logo { background: linear-gradient(135deg, #5C2D91 0%, #7E3FD1 100%); color: white; }
        .ime-logo { background: linear-gradient(135deg, #FF5722 0%, #FF8A65 100%); color: white; }
        .esewa-logo { background: linear-gradient(135deg, #53C351 0%, #81C784 100%); color: white; }
        .bank-logo { background: linear-gradient(135deg, #2196F3 0%, #64B5F6 100%); color: white; }
        .payment-info { flex-grow: 1; }
        .payment-name { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .payment-number { font-size: 14px; color: var(--text-secondary); font-family: monospace; }
        .pay-now-btn { padding: 8px 16px; border-radius: 20px; background: var(--gradient-primary); color: white; font-size: 12px; font-weight: 600; cursor: pointer; border: none; transition: var(--transition); }
        .pay-now-btn:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(95, 95, 245, 0.3); }
        .form-section { padding: 16px; background: var(--surface-bg); border-radius: var(--md-radius); box-shadow: var(--card-shadow); margin: 24px 0; }
        .input-wrapper { position: relative; margin: 16px 0; }
        .input-wrapper input { width: 100%; padding: 16px 16px 16px 48px; border: 1px solid #E0E0E0; border-radius: 12px; font-size: 16px; transition: var(--transition); background-color: var(--surface-bg); }
        .input-wrapper input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(95, 95, 245, 0.1); }
        .input-wrapper i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--primary-color); z-index: 10; font-size: 18px; }
        .input-wrapper .question-icon { left: unset; right: 16px; color: var(--warning-color); cursor: pointer; transition: var(--transition); transform: translateY(-50%); }
        .input-wrapper .question-icon:hover { transform: translateY(-50%) scale(1.1); }
        .input-wrapper input#topup-transaction-id { padding-right: 48px; }
        .submit-btn { text-align: center; margin: 24px 0; padding: 16px; background: var(--gradient-primary); color: var(--text-light); border-radius: 12px; font-weight: 600; cursor: pointer; transition: var(--transition); box-shadow: 0 4px 12px rgba(95, 95, 245, 0.3); pointer-events: auto; opacity: 1; }
        .submit-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(95, 95, 245, 0.4); }
        .helper-text { text-align: center; margin-bottom: 24px; font-weight: 500; color: var(--primary-color); cursor: pointer; transition: var(--transition); }
        .helper-text:hover { text-decoration: underline; }
        .bottom-nav-container { position: fixed; bottom: 0; left: 50%; transform: translateX(-50%); width: 100%; max-width: 480px; padding: 16px; z-index: 1000; background: transparent; pointer-events: none; }
        .bottom-nav { width: 100%; display: flex; justify-content: space-around; background: var(--surface-bg); padding: 12px 16px; border-radius: 24px; box-shadow: var(--floating-shadow); pointer-events: all; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--text-secondary); cursor: pointer; padding: 8px 12px; border-radius: 16px; transition: var(--transition); flex: 1; margin: 0 4px; }
        .nav-icon { font-size: 20px; margin-bottom: 4px; transition: var(--transition); }
        .nav-text { font-size: 10px; font-weight: 500; transition: var(--transition); }
        .nav-item.active { color: var(--primary-color); background: rgba(95, 95, 245, 0.1); transform: translateY(-5px); }
        .nav-item.active .nav-icon { transform: scale(1.1); }
        .page { display: none; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 3000; display: none; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        .drawer-overlay.visible { display: block; opacity: 1; }
        .profile-drawer { position: fixed; top: 0; left: 0; width: 85%; height: 100%; background: var(--surface-bg); z-index: 4000; box-shadow: 5px 0 25px rgba(0, 0, 0, 0.15); transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; overflow-y: auto; }
        .profile-drawer.open { transform: translateX(0); }
        .profile-header { display: flex; align-items: center; padding: 32px 24px 24px; background: var(--gradient-primary); color: white; }
        .profile-image { width: 80px; height: 80px; border-radius: 50%; margin-right: 16px; object-fit: cover; border: 3px solid rgba(255, 255, 255, 0.3); }
        .user-info { display: flex; flex-direction: column; justify-content: center; }
        .user-name { font-size: 20px; font-weight: 600; margin-bottom: 4px; }
        .user-bio { font-size: 14px; opacity: 0.9; }
        .menu-button { display: flex; align-items: center; padding: 16px 24px; cursor: pointer; transition: var(--transition); border-bottom: 1px solid #f0f0f0; }
        .menu-button:hover { background-color: rgba(95, 95, 245, 0.05); }
        .menu-button:last-child { border-bottom: none; }
        .menu-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; margin-right: 16px; font-size: 18px; }
        .menu-text { font-size: 16px; color: var(--text-primary); font-weight: 500; }
        .menu-spacer { flex-grow: 1; }
        .bottom-actions { margin-top: auto; padding: 16px 0; }
        .danger { color: var(--danger-color) !important; }
        .order-card { background-color: var(--surface-bg); border-radius: var(--md-radius); box-shadow: var(--card-shadow); padding: 16px; margin-bottom: 16px; display: flex; align-items: center; justify-content: space-between; border-left: 5px solid var(--primary-color); }
        .order-card.status-pending-card { border-left-color: var(--warning-color); }
        .order-card.status-completed-card { border-left-color: var(--success-color); } 
        .order-card.status-failed-card, .order-card.status-cancelled-card { border-left-color: var(--danger-color); }
        .order-details { flex-grow: 1; }
        .order-product { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .order-amount { font-size: 14px; color: var(--primary-color); font-weight: 700; }
        .order-status { padding: 6px 12px; border-radius: 16px; font-size: 12px; font-weight: 600; color: white; min-width: 80px; text-align: center; margin-left: 10px; }
        .status-pending { background-color: var(--warning-color); }
        .status-completed { background-color: var(--success-color); } 
        .status-failed, .status-cancelled { background-color: var(--danger-color); } 
        .qr-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 5000; display: none; align-items: center; justify-content: center; transition: opacity 0.3s ease; opacity: 0; }
        .qr-modal-overlay.visible { display: flex; opacity: 1; }
        .qr-modal-content { background: var(--surface-bg); border-radius: var(--lg-radius); padding: 30px 20px; width: 90%; max-width: 350px; box-shadow: var(--floating-shadow); text-align: center; transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .qr-modal-overlay.visible .qr-modal-content { transform: scale(1); }
        #qrcode-container { padding: 15px; background-color: var(--surface-bg); border: 1px solid #eee; border-radius: 12px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); display: inline-block; margin-bottom: 20px; }
        .qr-modal-title { font-size: 20px; font-weight: 700; color: var(--primary-color); margin-bottom: 10px; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .qr-modal-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
        .qr-uid-text { font-family: monospace; font-size: 12px; color: var(--text-primary); word-break: break-all; padding: 8px; background-color: #f0f0f0; border-radius: var(--sm-radius); margin-bottom: 20px; }
        .close-qr-modal-btn { background: var(--danger-color); color: white; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: var(--transition); }
        .info-modal-content { background: var(--surface-bg); border-radius: var(--md-radius); padding: 25px 20px; width: 90%; max-width: 350px; box-shadow: var(--floating-shadow); text-align: center; animation: zoomIn 0.3s ease; }
        .info-modal-content h3 { color: var(--primary-color); margin-bottom: 10px; }
        .info-modal-content p { font-size: 14px; color: var(--text-primary); margin-bottom: 20px; line-height: 1.5; text-align: left; }
        .info-modal-content .highlight { font-weight: 600; color: var(--danger-color); }
        @keyframes zoomIn { from { transform: scale(0.7); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .bank-selection { 
            margin-top: 20px; 
        }
        .bank-selection h3 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }
        #bank-select-dropdown {
            width: 100%;
            padding: 16px 16px 16px 48px; 
            border: 1px solid #E0E0E0;
            border-radius: 12px;
            font-size: 16px;
            transition: var(--transition);
            background-color: var(--surface-bg);
            appearance: none; 
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 16px top 50%;
            background-size: 16px;
            cursor: pointer;
        }
        #bank-select-dropdown:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(95, 95, 245, 0.1);
        }
        .bank-options {
            display: none; 
        }
        
        .qr-icon { margin-left: 10px; cursor: pointer; color: var(--primary-color); transition: var(--transition); }
        .qr-icon:hover { transform: scale(1.1); }
        
        /* New styles for reseller admin button */
        .reseller-admin-btn {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
            width: 100%;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .reseller-admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 165, 0, 0.4);
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Professional Leaderboard Styles */
        .leaderboard-section {
            margin: 24px 0;
        }

        .leaderboard-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .leaderboard-title {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #5F5FF5, #8A8AFF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .leaderboard-subtitle {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .top-three-container {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            gap: 16px;
            margin-bottom: 32px;
            padding: 0 16px;
        }

        .podium-card {
            background: white;
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            flex: 1;
            max-width: 120px;
            cursor: pointer;
        }

        .podium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 28px rgba(0,0,0,0.15);
        }

        .podium-card.first-place {
            order: 2;
            background: linear-gradient(135deg, #FFF9E6, #FFEB99);
            border: 2px solid #FFD700;
            transform: scale(1.1);
            z-index: 3;
        }

        .podium-card.second-place {
            order: 1;
            background: linear-gradient(135deg, #F8F8F8, #E8E8E8);
            border: 2px solid #C0C0C0;
            z-index: 2;
        }

        .podium-card.third-place {
            order: 3;
            background: linear-gradient(135deg, #FAF0E6, #F5E6D3);
            border: 2px solid #CD7F32;
            z-index: 1;
        }

        .rank-badge {
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .first-place .rank-badge {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .second-place .rank-badge {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
        }

        .third-place .rank-badge {
            background: linear-gradient(135deg, #CD7F32, #B5651D);
        }

        .podium-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 12px;
            border: 3px solid;
        }

        .first-place .podium-avatar {
            border-color: #FFD700;
            width: 80px;
            height: 80px;
        }

        .second-place .podium-avatar {
            border-color: #C0C0C0;
        }

        .third-place .podium-avatar {
            border-color: #CD7F32;
        }

        .podium-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .podium-membership {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            display: inline-block;
        }

        .membership-premium {
            background: linear-gradient(135deg, #5F5FF5, #8A8AFF);
        }

        .membership-gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .membership-silver {
            background: linear-gradient(135deg, #C0C0C0, #A0A0A0);
        }

        .membership-bronze {
            background: linear-gradient(135deg, #CD7F32, #B5651D);
        }

        .other-users-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 0 16px;
        }

        .other-user-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .other-user-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }

        .other-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-bottom: 8px;
            border: 2px solid var(--primary-light);
        }

        .other-user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .other-user-membership {
            font-size: 11px;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 10px;
            color: white;
        }

        /* Profile Popup Styles */
        .profile-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 3000;
            padding: 16px;
        }

        .profile-popup-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .profile-popup-card {
            background: white;
            border-radius: 20px;
            max-width: 320px;
            width: 100%;
            overflow: hidden;
            box-shadow: var(--floating-shadow);
            position: relative;
            transform: scale(0.95) translateY(10px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .profile-popup-overlay.active .profile-popup-card {
            transform: scale(1) translateY(0);
            opacity: 1;
        }

        .profile-popup-header {
            padding: 20px 20px 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            color: white;
            text-align: center;
            position: relative;
        }

        .profile-popup-close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: none;
            color: white;
        }

        .profile-popup-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .profile-popup-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-popup-body {
            padding: 24px 20px;
            text-align: center;
        }

        .profile-popup-image {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid var(--primary-light);
            margin: 0 auto 16px;
        }

        .profile-popup-info {
            text-align: center;
        }

        .profile-popup-name {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .profile-popup-balance {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 6px;
        }

        .profile-popup-phone {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .profile-popup-membership {
            margin-top: 12px;
        }

        .membership-badge {
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        /* Terms and Conditions Checkbox */
        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            margin: 15px 0;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .terms-checkbox input {
            margin-right: 8px;
            margin-top: 2px;
        }

        .terms-checkbox a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .terms-checkbox a:hover {
            text-decoration: underline;
        }

        /* Responsive Design for Leaderboard */
        @media (max-width: 768px) {
            .top-three-container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }

            .podium-card {
                max-width: 200px;
                width: 100%;
            }

            .podium-card.first-place {
                order: 1;
                transform: scale(1);
            }

            .podium-card.second-place {
                order: 2;
            }

            .podium-card.third-place {
                order: 3;
            }

            .other-users-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .podium-card {
                max-width: 160px;
                padding: 16px 12px;
            }

            .podium-avatar {
                width: 60px;
                height: 60px;
            }

            .first-place .podium-avatar {
                width: 70px;
                height: 70px;
            }

            .other-users-grid {
                grid-template-columns: 1fr;
            }

            .profile-popup-card {
                max-width: 280px;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header" id="main-header">
        <div class="header-left">
            <div class="header-icon" id="open-drawer-btn">
                <i class="fas fa-bars"></i>
            </div>
            <div class="header-title" id="page-title">Mero Topup</div>
        </div>
        <div class="header-right">
            <div class="notification-badge" id="notification-badge">
                <div class="header-notification-icon" id="notification-icon">
                    <i class="fas fa-bell"></i>
                </div>
            </div>
            <img src="Profile.jpg" alt="Profile" class="header-profile-image" id="header-profile-img" /> 
        </div>
    </div>

    <div class="page active" id="page-home">
        <div class="main-content">
            <div class="balance-card">
                <div class="balance-title">Total Balance (NPR)</div>
                <div class="balance-amount">
                    <div class="amount" id="user-balance">...</div> 
                    <div class="currency">NPR</div>
                    <div class="visibility-icon" id="visibility-toggle"><i class="fas fa-eye"></i></div>
                    <div class="add-balance-btn action-required-btn" id="go-to-wallet-btn">Add Balance</div>
                </div>
                <div class="account-info">
                    <div class="account-text" id="account-number">...</div> 
                    <div class="copy-icon action-required-btn"><i class="fas fa-copy"></i></div>
                </div>
            </div>

            <div class="quick-actions">
                <div class="action-item action-required-btn" data-action="send"> <div class="action-icon"> <i class="fas fa-mobile-alt"></i> </div> <div class="action-name">Send</div> </div>
                <div class="action-item action-required-btn" id="open-qr-modal-btn"> <div class="action-icon"> <i class="fas fa-qrcode"></i> </div> <div class="action-name">QR Code</div> </div>
                <div class="action-item action-required-btn" data-action="chat"> <div class="action-icon"> <i class="fas fa-comment"></i> </div> <div class="action-name">Message</div> </div>
                <div class="action-item action-required-btn" data-action="history"> <div class="action-icon"> <i class="fas fa-history"></i> </div> <div class="action-name">History</div> </div>
            </div>

            <div class="section-title">Topup & Games</div>
            
            <div class="product-grid" id="product-grid">
                <div class="product-card action-required-btn" id="pubg-card">
                    <div class="product-image"><img width="180px" srcset="" src="https://firebasestorage.googleapis.com/v0/b/setmandu-603f9.firebasestorage.app/o/image_home%2F1763050346746.jpg?alt=media&token=fccc8323-fa2c-469c-b0d5-574fbf2b1276" alt="pubg"></img></div>
                    <div class="product-name">PUBG UC</div>
                </div>
                <div class="product-card action-required-btn" data-action="topup_uid">
                    <div class="product-image"><img data-wallet="170px" height="180px" srcset="" src="https://firebasestorage.googleapis.com/v0/b/setmandu-603f9.firebasestorage.app/o/image_home%2F1763050339449.jpg?alt=media&token=f5b55c75-d3df-427f-9fc1-c97e6d938d4e" alt="free fire"></img></div>
                    <div class="product-name">UID TOPUP</div>
                </div>
                <div class="product-card action-required-btn" data-action="unipin"> <div class="product-image"><img width="190px" srcset="" src="https://firebasestorage.googleapis.com/v0/b/setmandu-603f9.firebasestorage.app/o/image_home%2F1763050479309.jpg?alt=media&token=c4b6a0e9-c748-4707-b846-c6a663a1ee7e" alt="unipin"></div> <div class="product-name">UNIPIN</div> </div>
                <div class="product-card action-required-btn" data-action="membership"> 
                    <div class="product-image" style="background: linear-gradient(135deg, #F9D976 0%, #F5A623 100%);">
                        <i class="fas fa-gem" style="color: white; -webkit-text-fill-color: white;"></i>
                    </div> 
                    <div class="product-name" id="reseller-card-text">GET MEMBERSHIP</div> 
                </div>
            </div>

            <!-- Professional Leaderboard Section -->
            <div class="leaderboard-section">
                <div class="leaderboard-header">
                    <div class="leaderboard-title">Top Resellers</div>
                    <div class="leaderboard-subtitle">Our most successful members</div>
                </div>

                <div class="top-three-container" id="top-three-container">
                    <!-- Top 3 users will be loaded here dynamically -->
                </div>

                <div class="section-title" style="margin-top: 40px;">All Resellers</div>
                <div class="other-users-grid" id="other-users-container">
                    <!-- Other users will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <div class="page" id="page-order">
        <div class="main-content action-required-content">
            <div class="section-title">My Orders</div>
            
            <div id="orders-list-container">
                </div>

            <div id="empty-order-message" class="empty-page-content" style="text-align: center; padding: 40px 20px; display: none;">
                <i class="fas fa-list-alt" style="font-size: 64px; color: #e0e0e0; margin-bottom: 16px;"></i>
                <h3 style="color: var(--text-secondary); margin-bottom: 12px;">No Orders Yet</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">You haven't placed any orders yet.</p>
            </div>

            <div id="login-required-message" class="empty-page-content" style="text-align: center; padding: 40px 20px; display: block;">
                <i class="fas fa-list-alt" style="font-size: 64px; color: #e0e0e0; margin-bottom: 16px;"></i>
                <h3 style="color: var(--text-secondary); margin-bottom: 12px;">Please Login</h3>
                <p style="color: var(--text-secondary); margin-bottom: 24px;">Please login to view or place orders.</p>
                <div class="submit-btn active open-auth-modal-btn" style="max-width: 200px; margin: 0 auto;">Login / Sign Up</div>
            </div>
        </div>
    </div>

    <div class="page" id="page-payment">
        <div class="main-content action-required-content"> 
            <div class="payment-methods">
                <div class="payment-title">Select Wallet for Payment</div>
                
                <div class="payment-item action-required-btn" data-wallet="Khalti">
                    <div class="payment-logo khalti-logo"><i class="fas fa-wallet"></i></div>
                    <div class="payment-info"> <div class="payment-name">Khalti Pay</div> <div class="payment-number">9861513184</div> </div>
                    <i class="fas fa-qrcode qr-icon" data-wallet="Khalti"></i>
                    <i class="fas fa-check-circle" style="color: var(--primary-color); font-size: 24px; opacity: 0;"></i>
                </div>

                <div class="payment-item action-required-btn" data-wallet="IME">
                    <div class="payment-logo ime-logo"><i class="fas fa-mobile-alt"></i></div>
                    <div class="payment-info"> <div class="payment-name">IME Pay</div> <div class="payment-number">9861513184</div> </div>
                    <i class="fas fa-qrcode qr-icon" data-wallet="IME"></i>
                    <i class="fas fa-check-circle" style="color: var(--primary-color); font-size: 24px; opacity: 0;"></i>
                </div>

                <div class="payment-item action-required-btn" data-wallet="Esewa">
                    <div class="payment-logo esewa-logo"><i class="fas fa-money-check-alt"></i></div>
                    <div class="payment-info"> <div class="payment-name">Esewa Pay</div> <div class="payment-number">9861513184</div> </div>
                    <i class="fas fa-qrcode qr-icon" data-wallet="Esewa"></i>
                    <i class="fas fa-check-circle" style="color: var(--primary-color); font-size: 24px; opacity: 0;"></i>
                </div>
                
                <div class="payment-item action-required-btn" data-wallet="Bank">
                    <div class="payment-logo bank-logo"><i class="fas fa-university"></i></div>
                    <div class="payment-info"> <div class="payment-name">Bank Transfer</div> <div class="payment-number">1234567890123456</div> </div>
                    <i class="fas fa-qrcode qr-icon" data-wallet="Bank"></i>
                    <i class="fas fa-check-circle" style="color: var(--primary-color); font-size: 24px; opacity: 0;"></i>
                </div>
                
                <div class="bank-selection" id="bank-selection" style="display: none;">
                    <h3>Select Bank</h3>
                    <div class="input-wrapper">
                        <i class="fas fa-university"></i>
                        <select id="bank-select-dropdown">
                            <option value="" disabled selected>-- Select a Bank --</option>
                            <option value="nabil">Nabil Bank</option>
                            <option value="nepal">Nepal Bank</option>
                            <option value="kumari">Kumari Bank</option>
                            <option value="global">Global IME Bank</option>
                            <option value="nepal-investment">Nepal Investment Bank</option>
                            <option value="standard-chartered">Standard Chartered</option>
                            <option value="himalayan">Himalayan Bank</option>
                            <option value="everest">Everest Bank</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-section">
                    <div class="input-wrapper">
                        <i class="fas fa-phone"></i>
                        <input type="tel" id="topup-number" placeholder="Your mobile number (used for payment)" />
                    </div>
                    
                    <div class="input-wrapper">
                        <i class="fas fa-key"></i>
                        <input type="text" id="topup-transaction-id" placeholder="Enter transaction/reference ID" />
                        <i class="fas fa-question-circle question-icon" id="open-info-modal-btn"></i> 
                    </div>
                    
                    <div class="input-wrapper">
                        <i class="fas fa-wallet"></i>
                        <input type="number" id="topup-amount" placeholder="Enter amount" />
                    </div>

                    <div class="submit-btn active action-required-btn" id="request-topup-btn">Request Topup</div>
                   <a href="https://youtu.be/5RfSrsE5HxU?si=IOZnE-jjqxJCL6J8" id="how-to-add-money-link"> <div class="helper-text">How to add money?</div></a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="page" id="page-profile">
        <div class="main-content action-required-content">
            <div class="section-title">My Account</div>
            
            <div class="form-section">
                <div class="input-wrapper">
                    <i class="fas fa-user"></i>
                    <input type="text" placeholder="Full Name" id="profile-name-input" /> 
                </div>
                <div class="input-wrapper">
                    <i class="fas fa-envelope"></i>
                    <input type="email" placeholder="Email Address" id="profile-email-input" readonly /> 
                </div>
                <div class="input-wrapper">
                    <i class="fas fa-phone"></i>
                    <input type="tel" placeholder="Mobile Number" id="profile-number-input" /> 
                </div>
                
                <!-- Reseller Admin Button (Only for verified members) -->
                <div class="reseller-admin-btn" id="reseller-admin-btn" style="display: none;">
                    <i class="fas fa-crown"></i>
                    Reseller Admin
                </div>
                
                <div class="submit-btn active action-required-btn" id="update-profile-btn">Update Information</div>
                <p id="profile-status-message" style="text-align: center; color: var(--danger-color); font-size: 14px; margin-top: 10px;"></p>
            </div>
            
            <div class="section-title" style="margin-top: 32px;">Settings</div>
            
            <div class="form-section">
                 <div class="menu-button action-required-btn" data-action="order_list">
                    <div class="menu-icon"><i class="fas fa-history" style="color: var(--primary-color);"></i></div>
                    <span class="menu-text">Order List</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto; color: #ccc;"></i>
                </div>
                <div class="menu-button action-required-btn" data-action="leaderboard">
                    <div class="menu-icon"><i class="fas fa-trophy" style="color: var(--primary-color);"></i></div>
                    <span class="menu-text">Leaderboard</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto; color: #ccc;"></i>
                </div>
                <div class="menu-button action-required-btn" data-action="reviews">
                    <div class="menu-icon"><i class="fas fa-star" style="color: var(--primary-color);"></i></div>
                    <span class="menu-text">Reviews</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto; color: #ccc;"></i>
                </div>
                <div class="menu-button action-required-btn" data-action="contact">
                    <div class="menu-icon"><i class="fas fa-headset" style="color: var(--primary-color);"></i></div>
                    <span class="menu-text">Contact</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto; color: #ccc;"></i>
                </div>
                <div class="menu-button action-required-btn" data-action="security">
                    <div class="menu-icon"><i class="fas fa-shield-alt" style="color: var(--primary-color);"></i></div>
                    <span class="menu-text">Security</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto; color: #ccc;"></i>
                </div>
                <div class="menu-button action-required-btn" data-action="language">
                    <div class="menu-icon"><i class="fas fa-language" style="color: var(--primary-color);"></i></div>
                    <span class="menu-text">Language</span>
                    <i class="fas fa-chevron-right" style="margin-left: auto; color: #ccc;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Reseller Membership Dialog -->
<div class="reseller-dialog-overlay" id="reseller-dialog-overlay">
    <div class="reseller-dialog-card">
        <div class="reseller-dialog-header">
            <button class="reseller-close-btn">&times;</button>
            <div class="reseller-dialog-icon">
                <i class="fas fa-crown"></i>
            </div>
            <h2>Premium Reseller</h2>
            <div class="reseller-dialog-subtitle">Take Your Business to the Next Level</div>
        </div>
        <div class="reseller-dialog-body">
            <p>With our Premium Reseller membership, you can list your own items and easily provide top-up services to customers.</p>
            
            <div class="reseller-features-list">
                <div class="reseller-feature-item">
                    <div class="reseller-feature-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <div class="reseller-feature-text">Full Control and Management</div>
                </div>
                <div class="reseller-feature-item">
                    <div class="reseller-feature-icon">
                        <i class="fas fa-bolt"></i>
                    </div>
                    <div class="reseller-feature-text">Fast and Secure Process</div>
                </div>
                <div class="reseller-feature-item">
                    <div class="reseller-feature-icon">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <div class="reseller-feature-text">Premium Security and Support</div>
                </div>
            </div>
            
            <p>You get <strong>full control, fast processing, and secure experience</strong>.</p>
        </div>
        <div class="reseller-dialog-actions">
            <button class="reseller-btn-primary" id="reseller-subscribe-btn">
                <i class="fas fa-crown"></i> Get Premium
            </button>
            <button class="reseller-btn-secondary" id="reseller-later-btn">Later</button>
        </div>
    </div>
</div>

<!-- Confirmation Dialog for Topup -->
<div class="confirmation-dialog-overlay" id="topup-confirmation-dialog-overlay">
    <div class="confirmation-dialog-card">
        <div class="confirmation-dialog-header">
            <button class="confirmation-close-btn">&times;</button>
            <div class="confirmation-dialog-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h2>Confirm Topup Request</h2>
            <div class="confirmation-dialog-subtitle">Please check your details</div>
        </div>
        <div class="confirmation-dialog-body">
            <p>The details you are providing are shown below. If this is wrong, your account may be suspended.</p>
            
            <div class="reseller-features-list">
                <div class="reseller-feature-item">
                    <div class="reseller-feature-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                    <div class="reseller-feature-text">Wallet: <span id="confirm-wallet"></span></div>
                </div>
                <div class="reseller-feature-item">
                    <div class="reseller-feature-icon">
                        <i class="fas fa-phone"></i>
                    </div>
                    <div class="reseller-feature-text">Mobile Number: <span id="confirm-number"></span></div>
                </div>
                <div class="reseller-feature-item">
                    <div class="reseller-feature-icon">
                        <i class="fas fa-key"></i>
                    </div>
                    <div class="reseller-feature-text">Transaction ID: <span id="confirm-transaction-id"></span></div>
                </div>
                <div class="reseller-feature-item">
                    <div class="reseller-feature-icon">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="reseller-feature-text">Amount: NPR <span id="confirm-amount"></span></div>
                </div>
            </div>
            
            <p>Only proceed if you confirm that these details are true.</p>
        </div>
        <div class="confirmation-dialog-actions">
            <button class="confirmation-btn-primary" id="confirm-topup-btn">
                <i class="fas fa-check"></i> Details are correct, proceed
            </button>
            <button class="confirmation-btn-secondary" id="cancel-topup-btn">Check again</button>
        </div>
    </div>
</div>

<!-- Confirmation Dialog for Logout -->
<div class="confirmation-dialog-overlay" id="logout-confirmation-dialog-overlay">
    <div class="confirmation-dialog-card">
        <div class="confirmation-dialog-header">
            <button class="confirmation-close-btn">&times;</button>
            <div class="confirmation-dialog-icon">
                <i class="fas fa-sign-out-alt"></i>
            </div>
            <h2>Logout</h2>
            <div class="confirmation-dialog-subtitle">Do you want to logout?</div>
        </div>
        <div class="confirmation-dialog-body">
            <p>If you logout, you will need to login again.</p>
        </div>
        <div class="confirmation-dialog-actions">
            <button class="confirmation-btn-danger" id="confirm-logout-btn">
                <i class="fas fa-check"></i> Logout
            </button>
            <button class="confirmation-btn-secondary" id="cancel-logout-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Confirmation Dialog for Account Deletion -->
<div class="confirmation-dialog-overlay" id="delete-account-confirmation-dialog-overlay">
    <div class="confirmation-dialog-card">
        <div class="confirmation-dialog-header">
            <button class="confirmation-close-btn">&times;</button>
            <div class="confirmation-dialog-icon">
                <i class="fas fa-trash-alt"></i>
            </div>
            <h2>Delete Account</h2>
            <div class="confirmation-dialog-subtitle">This action cannot be undone</div>
        </div>
        <div class="confirmation-dialog-body">
            <p>Deleting your account will lose all your data, balance and history. Are you sure?</p>
            
            <p>If you want to delete your account, please contact admin.</p>
        </div>
        <div class="confirmation-dialog-actions">
            <button class="confirmation-btn-primary" id="contact-admin-btn">
                <i class="fas fa-headset"></i> Contact Admin
            </button>
            <button class="confirmation-btn-secondary" id="cancel-delete-account-btn">Cancel</button>
        </div>
    </div>
</div>

<!-- Profile Popup Dialog -->
<div class="profile-popup-overlay" id="profile-popup-overlay">
    <div class="profile-popup-card">
        <div class="profile-popup-header">
            <button class="profile-popup-close-btn">&times;</button>
            <div class="profile-popup-title">User Profile</div>
        </div>
        <div class="profile-popup-body">
            <img src="" alt="Profile" class="profile-popup-image" id="profile-popup-img" />
            <div class="profile-popup-info">
                <div class="profile-popup-name" id="profile-popup-name">Guest User</div>
                <div class="profile-popup-balance" id="profile-popup-balance">Balance: NPR 0.00</div>
                <div class="profile-popup-phone" id="profile-popup-phone">Phone: N/A</div>
                <div class="profile-popup-membership" id="profile-popup-membership" style="display: none;">
                    <span class="membership-badge" id="profile-membership-badge">PREMIUM</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="bottom-nav-container">
    <div class="bottom-nav">
         <div class="nav-item active" data-page="page-home">
            <i class="fas fa-home nav-icon"></i>
            <div class="nav-text">Home</div>
        </div>
        <div class="nav-item action-required-btn" data-page="page-order">
            <i class="fas fa-list-ul nav-icon"></i>
            <div class="nav-text">Order</div>
        </div>
        <div class="nav-item action-required-btn" data-page="page-payment">
            <i class="fas fa-wallet nav-icon"></i>
            <div class="nav-text">Wallet</div>
        </div>
        <div class="nav-item action-required-btn" data-page="page-profile">
            <i class="fas fa-user nav-icon"></i>
            <div class="nav-text">Profile</div>
        </div>
    </div>
</div>

<div class="drawer-overlay" id="drawer-overlay"></div>
<div class="profile-drawer" id="profile-drawer">
    <div class="profile-header">
        <img src="Profile.jpg" alt="User Profile" class="profile-image" id="drawer-profile-img" /> 
        <div class="user-info">
            <div class="user-name" id="drawer-user-name">Guest User</div> 
            <div class="user-bio" id="drawer-user-email">Login to see details</div> 
        </div>
    </div>

    <div class="menu-button" id="about-menu"> 
        <div class="menu-icon"><i class="fas fa-gem" style="color:#5F5FF5;"></i></div> 
        <span class="menu-text">About</span> 
    </div>

    <div class="menu-button" id="transactions-menu">
        <div class="menu-icon"><i class="fas fa-bolt" style="color:#FFC107;"></i></div> 
        <span class="menu-text">My Transactions</span> 
    </div>
    <div class="menu-button" id="help-support-menu">
        <div class="menu-icon"><i class="fas fa-hands-helping" style="color:#4CAF50;"></i></div> 
        <span class="menu-text">Help & Support</span> 
    </div>
    <div class="menu-button" id="privacy-menu">
        <div class="menu-icon"><i class="fas fa-shield-alt" style="color:#9C27B0;"></i></div> 
        <span class="menu-text">Privacy Policy</span> 
    </div>
    <div class="menu-button" id="terms-menu">
        <div class="menu-icon"><i class="fas fa-anchor" style="color:#FF5722;"></i></div> 
        <span class="menu-text">Terms Of Service (TOS)</span> 
    </div>
    
    <div class="menu-spacer"></div>

    <div class="bottom-actions">
        <div class="menu-button" id="delete-account-btn" style="display:none;">
            <div class="menu-icon"><i class="fas fa-trash-alt danger"></i></div>
            <span class="menu-text danger">Delete Account</span>
        </div>

        <div class="menu-button" id="auth-toggle-btn"> 
             <div class="menu-icon"><i class="fas fa-sign-in-alt danger" id="auth-icon"></i></div>
            <span class="menu-text danger" id="auth-text">Login / Sign Up</span>
        </div>
    </div>
</div>

<div class="qr-modal-overlay" id="qr-modal-overlay">
    <div class="qr-modal-content">
        <div class="qr-modal-title">My QR Code</div>
        <div class="qr-modal-subtitle">Scan this code to send money</div>
        <div id="qrcode-container"></div>
        <div class="qr-uid-text">UID: <span id="qr-display-uid">...</span></div>
        <div class="close-qr-modal-btn" id="close-qr-modal-btn">Close</div>
    </div>
</div>

<div class="qr-modal-overlay" id="wallet-qr-modal-overlay">
    <div class="qr-modal-content">
        <div class="qr-modal-title" id="wallet-qr-title">Wallet QR Code</div>
        <div class="qr-modal-subtitle" id="wallet-qr-subtitle">Scan this code to add money</div>
        <div id="wallet-qrcode-container"></div>
        <div class="qr-uid-text" id="wallet-qr-account">Account: 1234567890123456</div>
        <div class="close-qr-modal-btn" id="close-wallet-qr-modal-btn">Close</div>
    </div>
</div>

<div class="qr-modal-overlay" id="transaction-info-modal-overlay">
    <div class="info-modal-content">
        <h3>What is Transaction/Reference ID?</h3>
        <p>This is the <span class="highlight">unique ID</span> provided by your wallet when you make a payment through <span class="highlight">Khalti, IME Pay, or Esewa</span>.</p>
        <p>âš ï¸ **Important Notice:**</p>
        <p style="margin-bottom: 5px;">- Please use the <span class="highlight">exact transaction/reference ID</span> from your payment.</p>
        <p style="margin-bottom: 5px;">- If you enter a wrong or fake ID, your account <span class="highlight">balance will not be updated</span> and <span class="highlight">your money will not be refunded</span>.</p>
        <p style="margin-bottom: 5px;">- Find the correct ID in your wallet's <span class="highlight">History/Transaction</span> section.</p>
        <div class="close-qr-modal-btn" id="close-info-modal-btn" style="background: var(--success-color); margin-top: 20px;">Understood, Close</div>
    </div>
</div>

<div class="auth-modal-overlay" id="auth-modal-overlay">
    <div class="auth-container">

        <div class="auth-form-wrapper active" id="auth-signup-form">
            <div class="title" data-lang="signup_title">Create Account</div>
            <div class="subtitle" data-lang="signup_sub">Join Tap and start your journey!</div>

            <label class="avatar-container" for="auth-avatar-input" id="auth-avatar-display">
                <span class="material-icons" id="auth-avatar-icon">add_a_photo</span>
                <img id="auth-avatar-preview" style="display:none;">
            </label>
            <input type="file" id="auth-avatar-input" accept="image/*">

            <div class="input-field">
                <span class="material-icons">badge</span>
                <input type="text" placeholder="Full Name" required id="signup-name-input">
            </div>
            <div class="input-field">
                <span class="material-icons">phone</span>
                <input type="tel" placeholder="Phone Number" required id="signup-phone-input">
            </div>
            <div class="input-field">
                <span class="material-icons">mail</span>
                <input type="email" placeholder="Email Address" required id="signup-email-input">
            </div>
            <div class="input-field">
                <span class="material-icons">lock</span>
                <input type="password" placeholder="Password" required id="signup-password-input">
            </div>

            <!-- Terms and Conditions Checkbox -->
            <div class="terms-checkbox">
                <input type="checkbox" id="terms-checkbox" required>
                <label for="terms-checkbox">
                    I agree to the <a href="javascript:void(0)" onclick="redirectToTerms()">Terms of Service</a>
                </label>
            </div>

            <button class="action-btn" id="signup-action-btn" data-lang="signup_btn" disabled>Sign Up</button>

            <div class="bottom-text">
                <span data-lang="already_text">Already have an account?</span>
                <a href="#" onclick="switchAuthForm('auth-login-form')" data-lang="login_link">Login</a>
            </div>

            <div class="lang-select">
                ðŸŒ <select id="auth-lang-switch">
                    <option value="en">English</option>
                    <option value="ne">à¤¨à¥‡à¤ªà¤¾à¤²à¥€</option>
                </select>
            </div>
        </div>

        <div class="auth-form-wrapper" id="auth-login-form">
            <div class="title" data-lang="login_title">Welcome Back</div>
            <div class="subtitle" data-lang="login_sub">Login to your Tap account</div>

            <div class="input-field">
                <span class="material-icons">mail</span>
                <input type="email" placeholder="Email Address" required id="login-email-input">
            </div>
            <div class="input-field">
                <span class="material-icons">lock</span>
                <input type="password" placeholder="Password" required id="login-password-input">
            </div>

            <div class="forgot-link">
                <a href="#" id="auth-forgot-password-link" data-lang="forgot_text">Forgot Password?</a>
            </div>

            <button class="action-btn" id="login-action-btn" data-lang="login_btn">Login</button>

            <div class="bottom-text">
                <span data-lang="dont_text">Don't have an account?</span>
                <a href="#" onclick="switchAuthForm('auth-signup-form')" data-lang="signup_link">Sign Up</a>
            </div>

            <div class="lang-select">
                ðŸŒ <select id="auth-lang-switch2">
                    <option value="en">English</option>
                    <option value="ne">à¤¨à¥‡à¤ªà¤¾à¤²à¥€</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div id="toast-container"></div>

<div id="forgot-modal">
    <div class="modal-content">
        <h3>Reset Password</h3>
        <p>Enter your email address to receive a password reset link.</p>
        <div class="input-field">
            <span class="material-icons">mail</span>
            <input type="email" placeholder="Enter Email" required id="reset-email">
        </div>
        <div class="modal-actions">
            <button id="reset-cancel-btn">Cancel</button>
            <button id="reset-send-btn">Send Reset Link</button>
        </div>
    </div>
</div>

<script>
// Global variables
let currentUserId = null;
let currentUserName = null; 
let currentUserNumber = null; 
let qrcodeInstance = null; 
let selectedWallet = null; 
let isUserLoggedIn = false;
let selectedBank = null;
let userMembershipData = null;

// Redirect functions
function redirectToSendMoney() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || ""
    };
    sessionStorage.setItem('send_money_user_data', JSON.stringify(userData));
    window.location.href = 'send_money.html';
}

function redirectToChat() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || ""
    };
    sessionStorage.setItem('chat_user_data', JSON.stringify(userData));
    window.location.href = 'chat.html';
}

// Redirect to membership page
function redirectToMembership() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }

    const user = auth.currentUser;

    if (user) {
        const userData = {
            uid: user.uid,
            name: currentUserName || "",
            number: currentUserNumber || "",
            email: user.email || "",
            balance: document.getElementById('user-balance')?.textContent || "0.00",
            profilePic: document.getElementById('header-profile-img')?.src || ""
        };

        sessionStorage.setItem('membership_user_data', JSON.stringify(userData));
        window.location.href = 'membership.html';
    } else {
        alert("Authentication error! Please login again.");
        openAuthModal();
    }
}

// Redirect to appropriate admin page based on membership plan
function redirectToResellerAdmin() {
    if (!currentUserId) {
        alert("User data not loaded. Please re-login.");
        return;
    }

    if (!userMembershipData) {
        alert("You don't have any membership plan. Please purchase a membership first.");
        redirectToMembership();
        return;
    }

    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || "",
        membership: userMembershipData
    };

    sessionStorage.setItem('admin_user_data', JSON.stringify(userData));

    // Redirect based on membership plan
    switch(userMembershipData.plan) {
        case 'bronze':
            window.location.href = 'admin_bronze.html';
            break;
        case 'silver':
            window.location.href = 'admin_silver.html';
            break;
        case 'gold':
            window.location.href = 'admin_gold.html';
            break;
        case 'premium':
            window.location.href = 'admin_premium.html';
            break;
        default:
            window.location.href = 'admin_bronze.html';
    }
}

// Redirect to Unipin page
function redirectToUnipin() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    if (!currentUserId || !currentUserName) {
        alert("User data not loaded yet. Please wait a moment.");
        return;
    }

    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || ""
    };

    sessionStorage.setItem("UNIPIN_USER_DATA", JSON.stringify(userData));
    window.location.href = 'unipin.html';
}

// Check for unread notifications
function checkUnreadNotifications(uid) {
    const notificationsRef = db.ref('user_notifications');
    notificationsRef.orderByChild('userId').equalTo(uid).on('value', (snapshot) => {
        let hasUnread = false;
        snapshot.forEach(childSnapshot => {
            const notification = childSnapshot.val();
            if (!notification.read) {
                hasUnread = true;
                return true; // Break loop
            }
        });
        
        const badge = document.getElementById('notification-badge');
        if (badge) {
            if (hasUnread) {
                badge.classList.add('has-unread');
            } else {
                badge.classList.remove('has-unread');
            }
        }
    });
}

// Professional Leaderboard Functions
function loadTopUsers() {
    const topThreeContainer = document.getElementById('top-three-container');
    const otherUsersContainer = document.getElementById('other-users-container');
    
    // Clear existing content
    if (topThreeContainer) topThreeContainer.innerHTML = '';
    if (otherUsersContainer) otherUsersContainer.innerHTML = '';
    
    // Show loading state
    if (topThreeContainer) {
        topThreeContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">Loading top users...</div>';
    }
    
    // Fetch membership users from Firebase
    if (!db) {
        console.error("Firebase database not initialized");
        return;
    }

    db.ref('membership_users').once('value').then(snapshot => {
        const users = [];
        snapshot.forEach(childSnapshot => {
            const user = childSnapshot.val();
            // Only include users with userName and plan
            if (user.userName && user.plan) {
                user.id = childSnapshot.key; // Add the user ID for redirection
                users.push(user);
            }
        });
        
        if (users.length === 0) {
            if (topThreeContainer) {
                topThreeContainer.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 20px;">No reseller users found</div>';
            }
            return;
        }
        
        // Sort users by plan level (Premium > Gold > Silver > Bronze)
        const planOrder = { 'premium': 4, 'gold': 3, 'silver': 2, 'bronze': 1 };
        users.sort((a, b) => {
            const planDiff = planOrder[b.plan] - planOrder[a.plan];
            if (planDiff !== 0) return planDiff;
            
            const aDate = a.purchaseDate ? new Date(a.purchaseDate) : new Date(0);
            const bDate = b.purchaseDate ? new Date(b.purchaseDate) : new Date(0);
            return bDate - aDate;
        });
        
        // Separate top 3 and other users
        const topUsers = users.slice(0, 3);
        const otherUsers = users.slice(3);
        
        // Clear loading state
        if (topThreeContainer) topThreeContainer.innerHTML = '';
        
        // Display top 3 users in podium
        topUsers.forEach((user, index) => {
            const userCard = createPodiumCard(user, index + 1);
            if (topThreeContainer) topThreeContainer.appendChild(userCard);
        });
        
        // Display other users
        otherUsers.forEach(user => {
            const userCard = createOtherUserCard(user);
            if (otherUsersContainer) otherUsersContainer.appendChild(userCard);
        });
        
    }).catch(error => {
        console.error("Error loading top users:", error);
        if (topThreeContainer) {
            topThreeContainer.innerHTML = '<div style="text-align: center; color: var(--danger-color); padding: 20px;">Error loading users</div>';
        }
    });
}

// Create Podium Card for Top 3
function createPodiumCard(user, rank) {
    const card = document.createElement('div');
    card.className = `podium-card ${getRankClass(rank)}`;
    
    const membershipClass = `membership-${user.plan}`;
    const membershipText = user.plan.charAt(0).toUpperCase() + user.plan.slice(1);
    
    card.innerHTML = `
        <div class="rank-badge">${rank}</div>
        <img src="${user.profilePic || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80'}" 
             alt="${user.userName}" class="podium-avatar" />
        <div class="podium-name">${user.userName}</div>
        <div class="podium-membership ${membershipClass}">${membershipText}</div>
    `;
    
    // Add click event for reseller redirection
    card.addEventListener('click', () => {
        redirectToResellerTopup(user);
    });
    
    return card;
}

// Create Other User Card
function createOtherUserCard(user) {
    const card = document.createElement('div');
    card.className = 'other-user-card';
    
    const membershipClass = `membership-${user.plan}`;
    const membershipText = user.plan.charAt(0).toUpperCase() + user.plan.slice(1);
    
    card.innerHTML = `
        <img src="${user.profilePic || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80'}" 
             alt="${user.userName}" class="other-user-avatar" />
        <div class="other-user-name">${user.userName}</div>
        <div class="other-user-membership ${membershipClass}">${membershipText}</div>
    `;
    
    // Add click event for reseller redirection
    card.addEventListener('click', () => {
        redirectToResellerTopup(user);
    });
    
    return card;
}

function getRankClass(rank) {
    switch(rank) {
        case 1: return 'first-place';
        case 2: return 'second-place';
        case 3: return 'third-place';
        default: return '';
    }
}

// Redirect to reseller topup page
function redirectToResellerTopup(resellerUser) {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    // Prepare data for redirection
    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || ""
    };
    
    const resellerData = {
        id: resellerUser.id,
        name: resellerUser.userName,
        email: resellerUser.userEmail,
        profilePic: resellerUser.profilePic,
        membership: resellerUser.plan,
        phone: resellerUser.phoneNumber
    };
    
    sessionStorage.setItem('current_user_data', JSON.stringify(userData));
    sessionStorage.setItem('reseller_data', JSON.stringify(resellerData));
    
    window.location.href = 'reseller_topup.html';
}

// Profile Popup Functions
function showProfilePopup() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    const popup = document.getElementById('profile-popup-overlay');
    const popupImg = document.getElementById('profile-popup-img');
    const popupName = document.getElementById('profile-popup-name');
    const popupBalance = document.getElementById('profile-popup-balance');
    const popupPhone = document.getElementById('profile-popup-phone');
    const popupMembership = document.getElementById('profile-popup-membership');
    const membershipBadge = document.getElementById('profile-membership-badge');
    
    if (!popup || !popupImg || !popupName || !popupBalance || !popupPhone || !popupMembership || !membershipBadge) {
        console.error("Profile popup elements not found");
        return;
    }
    
    // Set user data
    popupImg.src = document.getElementById('header-profile-img').src;
    popupName.textContent = currentUserName || 'Guest User';
    popupBalance.textContent = `Balance: NPR ${document.getElementById('user-balance').textContent}`;
    popupPhone.textContent = `Phone: ${currentUserNumber || 'N/A'}`;
    
    // Show membership badge if user has membership
    if (userMembershipData) {
        popupMembership.style.display = 'block';
        membershipBadge.textContent = userMembershipData.plan.toUpperCase();
        membershipBadge.className = 'membership-badge';
        membershipBadge.classList.add(`membership-${userMembershipData.plan}`);
    } else {
        popupMembership.style.display = 'none';
    }
    
    popup.classList.add('active');
    document.body.style.overflow = 'hidden';
}

function closeProfilePopup() {
    const popup = document.getElementById('profile-popup-overlay');
    if (popup) {
        popup.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

// Reseller Dialog Functionality
function showResellerDialog() {
    // Don't show dialog if user has membership
    if (userMembershipData) {
        return;
    }

    const lastShown = localStorage.getItem('resellerDialogLastShown');
    const now = Date.now();
    const twentyFourHours = 24 * 60 * 60 * 1000;
    
    if (currentUserId) {
        db.ref('user/' + currentUserId).once('value').then(snapshot => {
            const userData = snapshot.val();
            if (userData && userData.verified_member === 'true') {
                return;
            }
            
            if (!lastShown || (now - parseInt(lastShown)) > twentyFourHours) {
                const dialog = document.getElementById('reseller-dialog-overlay');
                if (dialog) {
                    dialog.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    localStorage.setItem('resellerDialogLastShown', now.toString());
                }
            }
        });
    } else {
        if (!lastShown || (now - parseInt(lastShown)) > twentyFourHours) {
            const dialog = document.getElementById('reseller-dialog-overlay');
            if (dialog) {
                dialog.classList.add('active');
                document.body.style.overflow = 'hidden';
                localStorage.setItem('resellerDialogLastShown', now.toString());
            }
        }
    }
}

function closeResellerDialog() {
    const dialog = document.getElementById('reseller-dialog-overlay');
    if (dialog) {
        dialog.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

// Update UI based on membership status
function updateMembershipUI() {
    const resellerCard = document.getElementById('reseller-card-text');
    const resellerAdminBtn = document.getElementById('reseller-admin-btn');

    if (userMembershipData) {
        // User has membership - show Reseller Admin options
        if (resellerCard) resellerCard.textContent = 'RESELLER ADMIN';
        if (resellerAdminBtn) resellerAdminBtn.style.display = 'block';
        
        // Update drawer user name with premium badge
        const drawerUserName = document.getElementById('drawer-user-name');
        if (drawerUserName && userMembershipData.plan) {
            drawerUserName.innerHTML = `${currentUserName} <span class="premium-badge">${userMembershipData.plan.toUpperCase()}</span>`;
        }
    } else {
        // User doesn't have membership - show GET MEMBERSHIP
        if (resellerCard) resellerCard.textContent = 'GET MEMBERSHIP';
        if (resellerAdminBtn) resellerAdminBtn.style.display = 'none';
    }
}

// Load user membership data
function loadUserMembership(uid) {
    if (!db) {
        console.error("Firebase database not initialized");
        return;
    }

    db.ref('membership_users/' + uid).once('value').then(snapshot => {
        userMembershipData = snapshot.val();
        updateMembershipUI();
    }).catch(error => {
        console.error("Error loading membership data:", error);
        userMembershipData = null;
        updateMembershipUI();
    });
}

// Confirmation Dialog Functions
function showTopupConfirmationDialog() {
    const number = document.getElementById('topup-number').value.trim();
    const transactionId = document.getElementById('topup-transaction-id').value.trim();
    const amount = document.getElementById('topup-amount').value.trim();
    
    document.getElementById('confirm-wallet').textContent = selectedWallet;
    document.getElementById('confirm-number').textContent = number;
    document.getElementById('confirm-transaction-id').textContent = transactionId;
    document.getElementById('confirm-amount').textContent = amount;
    
    const dialog = document.getElementById('topup-confirmation-dialog-overlay');
    if (dialog) {
        dialog.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeTopupConfirmationDialog() {
    const dialog = document.getElementById('topup-confirmation-dialog-overlay');
    if (dialog) {
        dialog.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

function showLogoutConfirmationDialog() {
    const dialog = document.getElementById('logout-confirmation-dialog-overlay');
    if (dialog) {
        dialog.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeLogoutConfirmationDialog() {
    const dialog = document.getElementById('logout-confirmation-dialog-overlay');
    if (dialog) {
        dialog.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

function showDeleteAccountConfirmationDialog() {
    const dialog = document.getElementById('delete-account-confirmation-dialog-overlay');
    if (dialog) {
        dialog.classList.add('active');
        document.body.style.overflow = 'hidden';
    }
}

function closeDeleteAccountConfirmationDialog() {
    const dialog = document.getElementById('delete-account-confirmation-dialog-overlay');
    if (dialog) {
        dialog.classList.remove('active');
        document.body.style.overflow = 'auto';
    }
}

function resetPageScroll() {
    const mainContent = document.querySelector('.main-content');
    if (mainContent) mainContent.scrollTop = 0;
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}

function redirectToNotification() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || ""
    };
    sessionStorage.setItem('notification_user_data', JSON.stringify(userData));
    window.location.href = 'notification.html';
}

function redirectToTransactionHistory() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || ""
    };
    sessionStorage.setItem('transaction_history_user_data', JSON.stringify(userData));
    window.location.href = 'transaction_history.html';
}

function redirectToHelpSupport() {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }
    
    const userData = {
        uid: currentUserId,
        name: currentUserName,
        number: currentUserNumber,
        email: auth.currentUser?.email || "",
        balance: document.getElementById('user-balance')?.textContent || "0.00",
        profilePic: document.getElementById('header-profile-img')?.src || ""
    };
    sessionStorage.setItem('chat_user_data', JSON.stringify(userData));
    window.location.href = 'chat.html';
}

function redirectToAbout() {
    window.location.href = 'about.html';
}

function redirectToPrivacyPolicy() {
    window.location.href = 'privacy_policy.html';
}

function redirectToTermsOfService() {
    window.location.href = 'terms_of_service.html';
}

function redirectToTerms() {
    window.location.href = 'terms_of_service.html';
}

// Unipin Message Function - Updated to redirect instead of showing message
function showUnipinMessage() {
    redirectToUnipin();
}

// Terms and Conditions Functions
function setupTermsAndConditions() {
    const signupBtn = document.getElementById('signup-action-btn');
    const termsCheckbox = document.getElementById('terms-checkbox');
    
    if (termsCheckbox && signupBtn) {
        termsCheckbox.addEventListener('change', function() {
            signupBtn.disabled = !this.checked;
        });
        
        // Initially disable signup button
        signupBtn.disabled = true;
    }
}

// DOM Element Reference
const requestTopupBtn = document.getElementById('request-topup-btn'); 

// Firebase Configuration
const FIREBASE_PROJECT_ID = "setmandu-603f9";
const FIREBASE_DATABASE_URL = "https://setmandu-603f9-default-rtdb.firebaseio.com";
const FIREBASE_API_KEY = "AIzaSyAa66d3C-rJln3tJAtZQBKYTn1WZHk2K3c";
const FIREBASE_STORAGE_BUCKET = "setmandu-603f9.firebasestorage.app";

const FCM_SENDER_ID = "297572978185";
const LOGIN_HTML_API_KEY = "AIzaSyC6w0qOO3rlOYGKFrsftdlp-PM8l3pV0J4";

const firebaseConfig = {
    apiKey: FIREBASE_API_KEY,
    authDomain: `${FIREBASE_PROJECT_ID}.firebaseapp.com`,
    projectId: FIREBASE_PROJECT_ID,
    databaseURL: FIREBASE_DATABASE_URL, 
    storageBucket: FIREBASE_STORAGE_BUCKET,
    messagingSenderId: FCM_SENDER_ID,
    appId: "1:297572978185:web:5d2a76f23c6f4b6d0872d8"
};

// Initialize Firebase
let auth, db, storage;
try {
    if(!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    auth = firebase.auth();
    db = firebase.database();
    storage = firebase.storage();
    console.log("Firebase initialized successfully");
} catch (e) {
    console.error("FATAL ERROR: Firebase SDK failed to initialize.", e);
}

let fcmToken = null; 
let profilePicURL = null; 
let isUploading = false; 
let currentUpload = null; 

// Utility function for displaying toasts
function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) {
        console.error("Toast container not found");
        return null;
    }
    
    const toast = document.createElement('div');
    toast.classList.add('toast', type);
    toast.innerHTML = `<span class="material-icons">${type === 'success' ? 'check_circle' : (type === 'error' ? 'error' : 'info')}</span> <span class="toast-message">${message}</span>`;
    
    container.appendChild(toast);
    
    setTimeout(() => { toast.classList.add('show'); }, 100);

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => { 
            if (toast.parentElement === container) {
                container.removeChild(toast); 
            }
        }, 500); 
    }, 6000); 
    return toast;
}

// Photo compression function
function compressImage(file, maxWidth = 500, quality = 0.7) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = event => {
            const img = new Image();
            img.src = event.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;

                if (width > height) {
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }
                } else {
                    if (height > maxWidth) {
                        width *= maxWidth / height;
                        height = maxWidth;
                    }
                }
                canvas.width = width;
                canvas.height = height;

                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                
                canvas.toBlob(blob => {
                    resolve(blob);
                }, 'image/jpeg', quality);
            };
            img.onerror = error => reject(error);
        };
        reader.onerror = error => reject(error);
    });
}

// Photo upload function
async function startProfilePicUpload(compressedBlob) {
    if (currentUpload) {
        currentUpload.cancel();
        isUploading = false;
        profilePicURL = null;
    }

    const tempUserId = `temp-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
    const storageRef = storage.ref();
    const fileRef = storageRef.child(`profile_pics_temp/${tempUserId}/profile.jpeg`);
    
    const uploadTask = fileRef.put(compressedBlob);

    currentUpload = uploadTask;
    isUploading = true;
    profilePicURL = null;

    let progressToast = showToast(`Photo Uploading in progress (0%)`, 'info');

    uploadTask.on(
        'state_changed',
        (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            const message = `Photo Uploading in progress (${Math.round(progress)}%)`;
            
            if (progressToast) {
                 progressToast.querySelector('.toast-message').textContent = message;
            } else {
                 progressToast = showToast(message, 'info');
            }
        },
        (error) => {
            isUploading = false;
            currentUpload = null;
            if (progressToast && progressToast.parentElement) progressToast.parentElement.removeChild(progressToast);
            showToast("Photo Upload Failed! Please select another picture or check network.", 'error');
            console.error("Upload Failed:", error);
        },
        async () => {
            isUploading = false;
            currentUpload = null;
            
            if (progressToast && progressToast.parentElement) progressToast.parentElement.removeChild(progressToast);
            
            try {
                const downloadURL = await fileRef.getDownloadURL();
                profilePicURL = {
                    url: downloadURL,
                    ref: fileRef 
                };
                showToast("âœ… Photo Upload Successful! Now you can click Sign Up.", 'success');
            } catch (error) {
                showToast("Failed to get download URL", 'error');
                console.error("Download URL error:", error);
            }
        }
    );
}

// Auth Modal Functions
function switchAuthForm(formId) {
    document.querySelectorAll('.auth-form-wrapper').forEach(f => f.classList.remove('active'));
    const form = document.getElementById(formId);
    if (form) {
        form.classList.add('active');
    }
    
    const selectedLang = document.getElementById('auth-lang-switch')?.value || 'en';
    if (formId === 'auth-signup-form') {
        const switch2 = document.getElementById('auth-lang-switch2');
        if (switch2) switch2.value = selectedLang;
    } else if (formId === 'auth-login-form') {
        const switch1 = document.getElementById('auth-lang-switch');
        if (switch1) switch1.value = selectedLang;
    }
}

function openAuthModal() {
    const authModal = document.getElementById('auth-modal-overlay');
    if (authModal) {
        authModal.classList.add('visible');
        document.body.style.overflow = 'hidden';
        switchAuthForm('auth-login-form');
    } else {
        console.error("Auth modal not found");
    }
}

function closeAuthModal() {
    const authModal = document.getElementById('auth-modal-overlay');
    if (authModal) {
        authModal.classList.remove('visible');
        document.body.style.overflow = 'auto';
    }
}

const langTexts = {
  en: {
    signup_title: "Create Account", signup_sub: "Join Tap and start your journey!", signup_btn: "Sign Up",
    already_text: "Already have an account?", login_link: "Login", login_title: "Welcome Back",
    login_sub: "Login to your Tap account", forgot_text: "Forgot Password?", login_btn: "Login",
    dont_text: "Don't have an account?", signup_link: "Sign Up"
  },
  ne: {
    signup_title: "à¤–à¤¾à¤¤à¤¾ à¤¬à¤¨à¤¾à¤‰à¤¨à¥à¤¹à¥‹à¤¸à¥", signup_sub: "Tap à¤¸à¤à¤— à¤†à¤«à¥à¤¨à¥‹ à¤¯à¤¾à¤¤à¥à¤°à¤¾ à¤¸à¥à¤°à¥ à¤—à¤°à¥à¤¨à¥à¤¹à¥‹à¤¸à¥!", signup_btn: "à¤¸à¤¾à¤‡à¤¨ à¤…à¤ª à¤—à¤°à¥à¤¨à¥à¤¹à¥‹à¤¸à¥",
    already_text: "à¤ªà¤¹à¤¿à¤²à¥‡ à¤¨à¥ˆ à¤–à¤¾à¤¤à¤¾ à¤›?", login_link: "à¤²à¤—à¤‡à¤¨ à¤—à¤°à¥à¤¨à¥à¤¹à¥‹à¤¸à¥", login_title: "à¤«à¤¿à¤°à¥à¤¤à¤¾ à¤¸à¥à¤µà¤¾à¤—à¤¤ à¤›",
    login_sub: "Tap à¤–à¤¾à¤¤à¤¾à¤®à¤¾ à¤²à¤—à¤‡à¤¨ à¤—à¤°à¥à¤¨à¥à¤¹à¥‹à¤¸à¥", forgot_text: "à¤ªà¤¾à¤¸à¤µà¤°à¥à¤¡ à¤¬à¤¿à¤°à¥à¤¸à¤¿à¤¨à¥à¤­à¤¯à¥‹?", login_btn: "à¤²à¤—à¤‡à¤¨",
    dont_text: "à¤…à¤à¥ˆ à¤–à¤¾à¤¤à¤¾ à¤›à¥ˆà¤¨?", signup_link: "à¤¸à¤¾à¤‡à¤¨ à¤…à¤ª à¤—à¤°à¥à¤¨à¥à¤¹à¥‹à¤¸à¥"
  }
};

function setLanguage(lang) {
  document.querySelectorAll('[data-lang]').forEach(el => {
    const key = el.getAttribute('data-lang');
    if (langTexts[lang] && langTexts[lang][key]) {
        el.innerText = langTexts[lang][key];
    }
  });
}

// Auth Handlers
async function handleSignUp(e) {
    if (e) e.preventDefault(); 
        
    const name = document.getElementById('signup-name-input')?.value.trim();
    const phone = document.getElementById('signup-phone-input')?.value.trim();
    const email = document.getElementById('signup-email-input')?.value.trim();
    const password = document.getElementById('signup-password-input')?.value;
    const submitBtn = document.getElementById('signup-action-btn');

    if (!name || !phone || !email || !password) {
        showToast("Please fill all required fields.", 'error');
        return; 
    }
    
    if (isUploading) {
        showToast("Photo is still uploading. Please wait for the upload completion message.", 'info');
        return;
    }
    if (!profilePicURL) {
        showToast("Profile picture not selected or upload failed. Please select a photo again.", 'error');
        return;
    }
        
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Finalizing...';
    submitBtn.disabled = true;
    let user = null; 
    let authUserCreated = false;
    let finalPhotoURL = profilePicURL.url; 

    try {
        if (!auth) {
            throw new Error("Firebase auth not initialized");
        }
        
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        user = userCredential.user;
        authUserCreated = true; 
            
        const currentFCMToken = fcmToken; 

        await db.ref('user/' + user.uid).set({ 
            Profilepic: finalPhotoURL, 
            balance: "0",
            block: "false",
            email: email,
            fmc: currentFCMToken || "", 
            name: name,
            number: phone,
            password: password, 
            uid: user.uid,
            verified_member: "false" 
        });
            
        showToast("âœ… Success! Account created. Welcome!", 'success');
        closeAuthModal();

        const redirectUrl = sessionStorage.getItem('redirect_after_login');
        if (redirectUrl) {
            sessionStorage.removeItem('redirect_after_login');
            window.location.href = redirectUrl;
        }

    } catch (error) {
        let errorMessage = "Sign Up Failed: An unknown error occurred.";
            
        if (authUserCreated && user) {
            try {
                await user.delete();
                errorMessage = "Account creation failed (Server/DB Error). Account rolled back. Please retry.";
            } catch (deleteError) {
                errorMessage = "Account creation failed. Please use a different email or contact support (Error: Failed to clean up Auth user).";
            }
        } else {
            switch (error.code) {
                case 'auth/email-already-in-use':
                    errorMessage = "This email is already in use. Please login.";
                    break;
                case 'auth/weak-password':
                    errorMessage = "Password must be at least 6 characters.";
                    break;
                default:
                    errorMessage = "Sign up failed: " + (error.message || "Unknown error occurred.");
            }
        }
        showToast(errorMessage, 'error');

    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        profilePicURL = null;
        isUploading = false;
        currentUpload = null;
    }
}

async function handleLogin(e) {
    if (e) e.preventDefault();

    const email = document.getElementById('login-email-input')?.value.trim();
    const password = document.getElementById('login-password-input')?.value;
    const submitBtn = document.getElementById('login-action-btn');
        
    if (!email || !password) {
        showToast("Please enter both email and password.", 'error');
        return;
    }

    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'Logging In...';
    submitBtn.disabled = true;

    try {
        if (!auth) {
            throw new Error("Firebase auth not initialized");
        }
        
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
            
        const currentFCMToken = fcmToken;
        if (currentFCMToken && db) {
             await db.ref(`user/${user.uid}/fmc`).set(currentFCMToken);
        }

        showToast("âœ… Login Successful!", 'success');
        closeAuthModal();

        const redirectUrl = sessionStorage.getItem('redirect_after_login');
        if (redirectUrl) {
            sessionStorage.removeItem('redirect_after_login');
            window.location.href = redirectUrl;
        }

    } catch (error) {
        let errorMessage;
            
        switch (error.code) {
            case 'auth/user-not-found':
            case 'auth/wrong-password':
            case 'auth/invalid-credential':
                errorMessage = "âŒ Login Failed: Email or password did not match.";
                break;
            default:
                errorMessage = "âŒ Login Failed: " + (error.message || "Unknown error occurred.");
        }
            
        showToast(errorMessage, 'error');

    } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    }
}

async function handlePasswordReset() {
    const emailInput = document.getElementById('reset-email');
    const email = emailInput?.value.trim();
    const sendBtn = document.getElementById('reset-send-btn');
    const originalText = sendBtn?.textContent;

    if (!email) {
        showToast("Please enter a valid email address.", 'error');
        return;
    }

    if (sendBtn) {
        sendBtn.textContent = 'Sending...';
        sendBtn.disabled = true;
    }

    try {
        if (!auth) {
            throw new Error("Firebase auth not initialized");
        }
        
        await auth.sendPasswordResetEmail(email);
        
        showToast("âœ… Success! Password reset link sent to your email.", 'success');
        const forgotModal = document.getElementById('forgot-modal');
        if (forgotModal) {
            forgotModal.style.display = 'none';
        }

    } catch (error) {
        let errorMessage;
        switch (error.code) {
            case 'auth/user-not-found':
            case 'auth/invalid-email':
                errorMessage = "If this email is registered, a password reset link has been sent.";
                showToast(errorMessage, 'success');
                const forgotModal = document.getElementById('forgot-modal');
                if (forgotModal) {
                    forgotModal.style.display = 'none';
                }
                break;
            default:
                errorMessage = "âŒ Reset Failed: " + (error.message || "Unknown error occurred.");
                showToast(errorMessage, 'error');
        }
    } finally {
        if (sendBtn) {
            sendBtn.textContent = originalText;
            sendBtn.disabled = false;
        }
        if (emailInput) {
            emailInput.value = '';
        }
    }
}

// Load user data
function loadUserData(uid) {
    currentUserId = uid; 
    
    const authText = document.getElementById('auth-text');
    const authIcon = document.getElementById('auth-icon');
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const userBalance = document.getElementById('user-balance');
    const accountNumber = document.getElementById('account-number');
    const loginRequiredMessage = document.getElementById('login-required-message');
    const emptyOrderMessage = document.getElementById('empty-order-message');
    
    if (authText) authText.textContent = 'Log out';
    if (authIcon) authIcon.classList.replace('fa-sign-in-alt', 'fa-sign-out-alt');
    if (deleteAccountBtn) deleteAccountBtn.style.display = 'flex';
    if (userBalance) userBalance.textContent = 'Loading...';
    if (accountNumber) accountNumber.textContent = 'Loading...';
    
    // Show appropriate order message
    if (loginRequiredMessage) loginRequiredMessage.style.display = 'none';
    if (emptyOrderMessage) emptyOrderMessage.style.display = 'block';
    
    if (!db) {
        console.error("Firebase database not initialized");
        return;
    }
    
    db.ref('user/' + uid).on('value', (snapshot) => {
        const userData = snapshot.val();
        
        if (userData) {
            currentUserName = userData.name || ''; 
            currentUserNumber = userData.number || '';
            
            const balance = parseFloat(userData.balance || 0).toFixed(2);
            if (userBalance) userBalance.textContent = balance;

            const visibilityIcon = document.getElementById('visibility-toggle');
            const balanceAmount = document.getElementById('user-balance');
            if (balanceAmount && balanceAmount.innerHTML !== '****') {
                balanceAmount.textContent = balance;
                actualBalance = balance; 
            } else {
                actualBalance = balance; 
            }

            if (accountNumber) accountNumber.textContent = userData.number || 'N/A';
            
            const profilePicUrl = userData.Profilepic || 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80';
            const headerProfileImg = document.getElementById('header-profile-img');
            const drawerProfileImg = document.getElementById('drawer-profile-img');
            if (headerProfileImg) headerProfileImg.src = profilePicUrl;
            if (drawerProfileImg) drawerProfileImg.src = profilePicUrl;

            const drawerUserName = document.getElementById('drawer-user-name');
            const drawerUserEmail = document.getElementById('drawer-user-email');
            const profileNameInput = document.getElementById('profile-name-input');
            const profileEmailInput = document.getElementById('profile-email-input');
            const profileNumberInput = document.getElementById('profile-number-input');
            
            if (drawerUserName) drawerUserName.textContent = userData.name || 'User';
            if (drawerUserEmail) drawerUserEmail.textContent = userData.email || 'N/A';
            if (profileNameInput) profileNameInput.value = userData.name || '';
            if (profileEmailInput) profileEmailInput.value = userData.email || '';
            if (profileNumberInput) profileNumberInput.value = userData.number || '';

            // Load membership data
            loadUserMembership(uid);
            
            // Check for unread notifications
            checkUnreadNotifications(uid);

        } else {
            console.error("User data not found in database for UID:", uid);
            if (userBalance) userBalance.textContent = '0.00';
            if (accountNumber) accountNumber.textContent = 'N/A';
        }
    }, (error) => {
        console.error("Failed to fetch user data:", error);
        if (userBalance) userBalance.textContent = 'Error!';
        if (accountNumber) accountNumber.textContent = 'Error!';
    });
    
    loadOrders(uid);
}

// Reset UI for logged out user
function resetUIForLoggedOutUser() {
    isUserLoggedIn = false;
    currentUserId = null;
    currentUserName = null;
    currentUserNumber = null;
    userMembershipData = null;
    
    const userBalance = document.getElementById('user-balance');
    const accountNumber = document.getElementById('account-number');
    const headerProfileImg = document.getElementById('header-profile-img');
    const drawerProfileImg = document.getElementById('drawer-profile-img');
    const drawerUserName = document.getElementById('drawer-user-name');
    const drawerUserEmail = document.getElementById('drawer-user-email');
    const profileNameInput = document.getElementById('profile-name-input');
    const profileEmailInput = document.getElementById('profile-email-input');
    const profileNumberInput = document.getElementById('profile-number-input');
    const authText = document.getElementById('auth-text');
    const authIcon = document.getElementById('auth-icon');
    const deleteAccountBtn = document.getElementById('delete-account-btn');
    const loginRequiredMessage = document.getElementById('login-required-message');
    const emptyOrderMessage = document.getElementById('empty-order-message');
    const ordersListContainer = document.getElementById('orders-list-container');
    const badge = document.getElementById('notification-badge');
    
    if (userBalance) userBalance.textContent = 'Login';
    if (accountNumber) accountNumber.textContent = 'Login to view';
    
    const defaultProfilePic = 'https://images.unsplash.com/photo-1535713875002-d1d0cf377fde?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=100&q=80';
    if (headerProfileImg) headerProfileImg.src = defaultProfilePic;
    if (drawerProfileImg) drawerProfileImg.src = defaultProfilePic;
    if (drawerUserName) drawerUserName.textContent = 'Guest User';
    if (drawerUserEmail) drawerUserEmail.textContent = 'Login to see details';
    if (profileNameInput) profileNameInput.value = '';
    if (profileEmailInput) profileEmailInput.value = '';
    if (profileNumberInput) profileNumberInput.value = '';
    if (authText) authText.textContent = 'Login / Sign Up';
    if (authIcon) authIcon.classList.replace('fa-sign-out-alt', 'fa-sign-in-alt');
    if (deleteAccountBtn) deleteAccountBtn.style.display = 'none';
    if (loginRequiredMessage) loginRequiredMessage.style.display = 'block';
    if (emptyOrderMessage) emptyOrderMessage.style.display = 'none';
    
    // Reset membership UI
    updateMembershipUI();
    
    // Hide notification badge
    if (badge) {
        badge.classList.remove('has-unread');
    }

    if (ordersListContainer) ordersListContainer.innerHTML = '';
    
    closeDrawer();
}

// Request topup function
async function requestTopup() {
    if (!requestTopupBtn || !requestTopupBtn.classList.contains('active')) {
        alert('âŒ Button is inactive. Please select a wallet.');
        return;
    }
    
    if (!currentUserId) {
        alert("User data not loaded. Please re-login.");
        return;
    }

    const number = document.getElementById('topup-number')?.value.trim();
    const transactionId = document.getElementById('topup-transaction-id')?.value.trim();
    const amount = parseFloat(document.getElementById('topup-amount')?.value.trim());

    if (!selectedWallet || !number || !transactionId || isNaN(amount) || amount <= 0) {
        alert('Please select a wallet and fill all details (mobile number, transaction ID, amount) correctly.');
        return;
    }
    
    if (selectedWallet === 'Bank' && !selectedBank) {
        alert('Please select a specific bank for Bank Transfer.');
        return;
    }
    
    showTopupConfirmationDialog();
}

// Actual topup request after confirmation
async function processTopupRequest() {
    const number = document.getElementById('topup-number')?.value.trim();
    const transactionId = document.getElementById('topup-transaction-id')?.value.trim();
    const amount = parseFloat(document.getElementById('topup-amount')?.value.trim());
    
    if (!requestTopupBtn) return;
    
    requestTopupBtn.textContent = 'Saving request data...';
    requestTopupBtn.classList.remove('active'); 

    try {
        if (!db) {
            throw new Error("Firebase database not initialized");
        }
        
        const newRef = db.ref('topup_requests').push();
        const requestKey = newRef.key; 
        const requestData = {
            requestKey: requestKey, 
            userId: currentUserId,
            userName: currentUserName,
            userEmail: auth.currentUser.email,
            wallet: selectedWallet,
            senderNumber: number,
            transactionId: transactionId,
            amount: amount,
            screenshotUrl: 'No Screenshot Required/Provided', 
            status: 'Pending', 
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            ...(selectedWallet === 'Bank' && { selectedBank: selectedBank }) 
        };
        await newRef.set(requestData);

        resetTopupForm();

        showToast(`âœ… Topup request sent successfully. (ID: ${requestKey}) \nStatus: Pending`, 'success');
        
        const orderNavItem = document.querySelector('.nav-item[data-page="page-order"]');
        if (orderNavItem) orderNavItem.click();

    } catch (error) {
        console.error("Topup request failed:", error);
        showToast(`âŒ Topup request failed: ${error.message} (Please try again)`, 'error');
    } finally {
        if (requestTopupBtn) {
            requestTopupBtn.textContent = 'Request Topup';
            if(selectedWallet) {
                requestTopupBtn.classList.add('active'); 
            } else {
                 requestTopupBtn.classList.remove('active');
            }
        }
    }
}

// Reset topup form
function resetTopupForm() {
    const topupNumber = document.getElementById('topup-number');
    const topupTransactionId = document.getElementById('topup-transaction-id');
    const topupAmount = document.getElementById('topup-amount');
    const bankSelection = document.getElementById('bank-selection');
    const bankDropdown = document.getElementById('bank-select-dropdown');
    
    if (topupNumber) topupNumber.value = '';
    if (topupTransactionId) topupTransactionId.value = '';
    if (topupAmount) topupAmount.value = '';
    
    document.querySelectorAll('.payment-item').forEach(item => {
        item.classList.remove('selected');
        const checkIcon = item.querySelector('.fa-check-circle');
        if (checkIcon) checkIcon.style.opacity = '0';
    });
    selectedWallet = null;
    
    if (bankSelection) bankSelection.style.display = 'none';
    if (bankDropdown) bankDropdown.value = '';
    selectedBank = null;
}

// Create order card
function createOrderCard(order) {
    const card = document.createElement('div');
    
    let statusClass;
    let statusTextClass;

    if (order.status === 'Completed' || order.status === 'Complete') {
        statusClass = 'status-completed-card';
        statusTextClass = 'status-completed';
    } else if (order.status === 'Pending') {
        statusClass = 'status-pending-card';
        statusTextClass = 'status-pending';
    } else { 
        statusClass = 'status-failed-card'; 
        statusTextClass = 'status-failed'; 
    }
    
    const date = new Date(order.timestamp).toLocaleDateString('en-US', { 
        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
    });
    
    const walletType = order.wallet === 'Bank' ? `${order.wallet} (${order.selectedBank || 'N/A'})` : order.wallet;

    card.className = `order-card ${statusClass}`;
    card.innerHTML = `
        <div class="order-details">
            <div class="order-product">ðŸ’° Wallet Topup (${walletType})</div>
            <div class="order-amount">NPR ${parseFloat(order.amount).toFixed(2)}</div>
            <small style="color: var(--text-secondary);">ID: ${order.transactionId} (${date})</small>
        </div>
        <div class="order-status ${statusTextClass}">${order.status}</div>
    `;
    return card;
}

// Load orders
function loadOrders(uid) {
    const container = document.getElementById('orders-list-container');
    const emptyMessage = document.getElementById('empty-order-message');
    const loginMessage = document.getElementById('login-required-message');
    
    if (!container) return;
    
    container.innerHTML = '';
    
    if (!isUserLoggedIn) {
        if (loginMessage) loginMessage.style.display = 'block';
        if (emptyMessage) emptyMessage.style.display = 'none';
        if (container) container.style.display = 'none';
        return;
    }
    
    if (loginMessage) loginMessage.style.display = 'none';
    
    if (!db) {
        console.error("Firebase database not initialized");
        return;
    }
    
    db.ref('topup_requests').orderByChild('userId').equalTo(uid).on('value', (snapshot) => {
        
        if (!container) return;
        container.innerHTML = '';
        const orders = [];

        snapshot.forEach(childSnapshot => {
            orders.push(childSnapshot.val());
        });
        
        orders.sort((a, b) => b.timestamp - a.timestamp);

        if (orders.length === 0) {
            if (emptyMessage) emptyMessage.style.display = 'block';
            if (container) container.style.display = 'none';
        } else {
            if (emptyMessage) emptyMessage.style.display = 'none';
            if (container) container.style.display = 'block';
            orders.forEach(order => {
                container.appendChild(createOrderCard(order));
            });
        }
    }, (error) => {
        console.error("Failed to load orders:", error);
        if (container) {
            container.innerHTML = `<p style="color: var(--danger-color); text-align: center;">Failed to load orders.</p>`;
        }
        if (emptyMessage) emptyMessage.style.display = 'none';
        if (loginMessage) loginMessage.style.display = 'none';
    });
}

// Update user profile
async function updateUserProfile() {
    const nameInput = document.getElementById('profile-name-input');
    const numberInput = document.getElementById('profile-number-input');
    const statusMsg = document.getElementById('profile-status-message');

    if (!nameInput || !numberInput || !statusMsg) {
        console.error("Profile update elements not found");
        return;
    }

    const nameValue = nameInput.value.trim();
    const numberValue = numberInput.value.trim();

    statusMsg.textContent = ''; 

    if (nameValue === currentUserName && numberValue === currentUserNumber) {
        statusMsg.textContent = 'âŒ No changes made!';
        statusMsg.style.color = 'var(--warning-color)';
        return;
    }
    
    if (!nameValue || !numberValue) {
        statusMsg.textContent = 'âŒ Name and number cannot be empty.';
        statusMsg.style.color = 'var(--danger-color)';
        return;
    }

    try {
        const updateBtn = document.getElementById('update-profile-btn');
        if (updateBtn) {
            updateBtn.textContent = 'Updating...';
            updateBtn.classList.remove('active');
        }

        if (!db) {
            throw new Error("Firebase database not initialized");
        }
        
        await db.ref('user/' + currentUserId).update({
            name: nameValue,
            number: numberValue
        });
        
        currentUserName = nameValue; 
        currentUserNumber = numberValue;

        statusMsg.textContent = 'âœ… Profile updated successfully!';
        statusMsg.style.color = 'var(--success-color)';

    } catch (error) {
        statusMsg.textContent = `âŒ Update failed: ${error.message}`;
        statusMsg.style.color = 'var(--danger-color)';
    } finally {
        const updateBtn = document.getElementById('update-profile-btn');
        if (updateBtn) {
            updateBtn.textContent = 'Update Information';
            updateBtn.classList.add('active');
        }
    }
}

// Handle action
function handleAction(actionType) {
    if (!isUserLoggedIn) {
        openAuthModal();
        return;
    }

    if (!currentUserId) {
        alert("User data is not fully loaded. Please wait a moment.");
        return;
    }
    
    let targetPage = null; 
    let param = `userId=${currentUserId}`;
    
    function handleOrdersRedirect() {
        if (!currentUserId || !currentUserName) {
            alert("User data not loaded yet. Please wait a moment.");
            return;
        }

        const userData = {
            uid: currentUserId,
            name: currentUserName,
            number: currentUserNumber,
            email: auth.currentUser?.email || "",
            balance: document.getElementById('user-balance')?.textContent || "0.00", 
            profilePic: document.getElementById('header-profile-img')?.src || ""
        };
        sessionStorage.setItem("UC_USER_DATA", JSON.stringify(userData));

        window.location.href = 'order_list.html';
    }
    
    function handleResellerTopup() {
        if (userMembershipData) {
            redirectToResellerAdmin();
        } else {
            redirectToMembership();
        }
    }

    function handleLeaderboardRedirect() {
        // Already on leaderboard (home page)
        const homeNavItem = document.querySelector('.nav-item[data-page="page-home"]');
        if (homeNavItem) homeNavItem.click();
    }
    
    function handleReviewsRedirect() {
        const userData = {
            uid: currentUserId,
            name: currentUserName,
            number: currentUserNumber,
            email: auth.currentUser?.email || "",
            balance: document.getElementById('user-balance')?.textContent || "0.00", 
            profilePic: document.getElementById('header-profile-img')?.src || ""
        };
        sessionStorage.setItem("USER_DATA", JSON.stringify(userData));
        window.location.href = 'reviews.html';
    }
    
    function handleContactRedirect() {
        const userData = {
            uid: currentUserId,
            name: currentUserName,
            number: currentUserNumber,
            email: auth.currentUser?.email || "",
            balance: document.getElementById('user-balance')?.textContent || "0.00", 
            profilePic: document.getElementById('header-profile-img')?.src || ""
        };
        sessionStorage.setItem("USER_DATA", JSON.stringify(userData));
        window.location.href = 'contact.html';
    }

    switch(actionType) {
        case 'send': 
            redirectToSendMoney();
            return;
        case 'chat': 
            redirectToChat();
            return;
        case 'history': 
            const orderNavItem = document.querySelector('.nav-item[data-page="page-order"]');
            if (orderNavItem) orderNavItem.click(); 
            return;
        case 'topup_pubg': targetPage = 'topup_pubg.html'; param += `&game=pubg`; break;
        case 'topup_uid': targetPage = 'topup_uid.html'; break;
        case 'unipin': 
            redirectToUnipin();
            return;
        case 'order_list':
            handleOrdersRedirect();
            return;
        case 'leaderboard':
            handleLeaderboardRedirect();
            return;
        case 'reviews':
            handleReviewsRedirect();
            return;
        case 'contact':
            handleContactRedirect();
            return;
        case 'reseller_topup':
            handleResellerTopup();
            return;
            
        case 'membership':
            redirectToMembership();
            return;
            
        case 'security':
        case 'language':
            alert(`Setting: ${actionType.toUpperCase()} Feature not implemented yet.`);
            return;

        case 'home_redirect':
            const homeNav = document.querySelector('.nav-item[data-page="page-home"]');
            if (homeNav) homeNav.click(); 
            return;
        default:
            alert(`Action not yet implemented: ${actionType}`);
            return;
    }
    
    if (targetPage) {
        console.log(`Redirecting to: ${targetPage}?${param}`); 
    }
}

// QR Code generation functions
function generateQRCode(uid) {
    const qrContainer = document.getElementById('qrcode-container');
    if (!qrContainer) {
        console.error("QR container not found");
        return;
    }
    
    if (qrcodeInstance) { 
        qrContainer.innerHTML = ''; 
        qrcodeInstance = null; 
    } 
    qrcodeInstance = new QRCode(qrContainer, {
        text: uid, width: 150, height: 150, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H
    });
    const qrDisplayUid = document.getElementById('qr-display-uid');
    if (qrDisplayUid) qrDisplayUid.textContent = uid;
    const qrModal = document.getElementById('qr-modal-overlay');
    if (qrModal) {
        qrModal.classList.add('visible');
        document.body.style.overflow = 'hidden';
    }
}

function closeQrModal() {
    const qrModal = document.getElementById('qr-modal-overlay');
    if (qrModal) {
        qrModal.classList.remove('visible');
        document.body.style.overflow = 'auto';
    }
}

// Wallet QR Code functions
function showWalletQR(wallet) {
    const walletQrContainer = document.getElementById('wallet-qrcode-container');
    const walletQrTitle = document.getElementById('wallet-qr-title');
    const walletQrSubtitle = document.getElementById('wallet-qr-subtitle');
    const walletQrAccount = document.getElementById('wallet-qr-account');
    
    if (!walletQrContainer || !walletQrTitle || !walletQrSubtitle || !walletQrAccount) {
        console.error("Wallet QR elements not found");
        return;
    }
    
    walletQrContainer.innerHTML = '';
    
    let accountNumber = '';
    let qrText = '';
    
    switch(wallet) {
        case 'Khalti':
            accountNumber = '9861513184';
            qrText = 'khalti://pay?pid=merotopup&mobile=9861513184';
            walletQrTitle.textContent = 'Khalti QR Code';
            walletQrSubtitle.textContent = 'Scan this code to add money via Khalti';
            break;
        case 'IME':
            accountNumber = '9861513184';
            qrText = 'imepay://pay?pid=merotopup&mobile=9861513184';
            walletQrTitle.textContent = 'IME Pay QR Code';
            walletQrSubtitle.textContent = 'Scan this code to add money via IME Pay';
            break;
        case 'Esewa':
            accountNumber = '9861513184';
            qrText = 'esewa://pay?pid=merotopup&mobile=9861513184';
            walletQrTitle.textContent = 'Esewa QR Code';
            walletQrSubtitle.textContent = 'Scan this code to add money via Esewa';
            break;
        case 'Bank':
            accountNumber = '1234567890123456';
            qrText = 'Bank Transfer: Account 1234567890123456';
            walletQrTitle.textContent = 'Bank QR Code';
            walletQrSubtitle.textContent = 'Scan this code for bank transfer details';
            break;
    }
    
    walletQrAccount.textContent = `Account: ${accountNumber}`;
    
    new QRCode(walletQrContainer, {
        text: qrText, 
        width: 150, 
        height: 150, 
        colorDark : "#000000", 
        colorLight : "#ffffff", 
        correctLevel : QRCode.CorrectLevel.H
    });
    
    const walletQrModal = document.getElementById('wallet-qr-modal-overlay');
    if (walletQrModal) {
        walletQrModal.classList.add('visible');
        document.body.style.overflow = 'hidden';
    }
}

function closeWalletQrModal() {
    const walletQrModal = document.getElementById('wallet-qr-modal-overlay');
    if (walletQrModal) {
        walletQrModal.classList.remove('visible');
        document.body.style.overflow = 'auto';
    }
}

// Transaction Info Modal Functions
function openTransactionInfoModal() {
    const infoModal = document.getElementById('transaction-info-modal-overlay');
    if (infoModal) {
        infoModal.classList.add('visible');
        document.body.style.overflow = 'hidden';
    }
}

function closeTransactionInfoModal() {
    const infoModal = document.getElementById('transaction-info-modal-overlay');
    if (infoModal) {
        infoModal.classList.remove('visible');
        document.body.style.overflow = 'auto';
    }
}

// Drawer Functions
function openDrawer() { 
    const profileDrawer = document.getElementById('profile-drawer');
    const drawerOverlay = document.getElementById('drawer-overlay');
    if (profileDrawer && drawerOverlay) {
        profileDrawer.classList.add('open'); 
        drawerOverlay.classList.add('visible'); 
        document.body.style.overflow = 'hidden'; 
    }
}

function closeDrawer() { 
    const profileDrawer = document.getElementById('profile-drawer');
    const drawerOverlay = document.getElementById('drawer-overlay');
    if (profileDrawer && drawerOverlay) {
        profileDrawer.classList.remove('open'); 
        drawerOverlay.classList.remove('visible'); 
        document.body.style.overflow = 'auto'; 
    }
}

// DOMContentLoaded Event Listener
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM loaded, initializing app...");
    
    // Initialize FCM token
    if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(function(registration) {
            console.log('Service Worker registered with scope:', registration.scope);
        })
        .catch(function(error) {
            console.log('Service Worker registration failed:', error);
        });
    }

    // Reseller Dialog Event Listeners
    const resellerSubscribeBtn = document.getElementById('reseller-subscribe-btn');
    const resellerLaterBtn = document.getElementById('reseller-later-btn');
    const resellerDialogOverlay = document.getElementById('reseller-dialog-overlay');
    const resellerCloseBtn = document.querySelector('.reseller-close-btn');

    if (resellerSubscribeBtn) {
        resellerSubscribeBtn.addEventListener('click', redirectToMembership);
    }
    if (resellerLaterBtn) {
        resellerLaterBtn.addEventListener('click', closeResellerDialog);
    }
    if (resellerDialogOverlay) {
        resellerDialogOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'reseller-dialog-overlay') {
                closeResellerDialog();
            }
        });
    }
    if (resellerCloseBtn) {
        resellerCloseBtn.addEventListener('click', closeResellerDialog);
    }

    // Topup Confirmation Dialog Event Listeners
    const confirmTopupBtn = document.getElementById('confirm-topup-btn');
    const cancelTopupBtn = document.getElementById('cancel-topup-btn');
    const topupConfirmationDialog = document.getElementById('topup-confirmation-dialog-overlay');
    const topupCloseBtn = document.querySelector('#topup-confirmation-dialog-overlay .confirmation-close-btn');

    if (confirmTopupBtn) {
        confirmTopupBtn.addEventListener('click', () => {
            closeTopupConfirmationDialog();
            processTopupRequest();
        });
    }
    if (cancelTopupBtn) {
        cancelTopupBtn.addEventListener('click', closeTopupConfirmationDialog);
    }
    if (topupConfirmationDialog) {
        topupConfirmationDialog.addEventListener('click', (e) => {
            if (e.target.id === 'topup-confirmation-dialog-overlay') {
                closeTopupConfirmationDialog();
            }
        });
    }
    if (topupCloseBtn) {
        topupCloseBtn.addEventListener('click', closeTopupConfirmationDialog);
    }

    // Logout Confirmation Dialog Event Listeners
    const confirmLogoutBtn = document.getElementById('confirm-logout-btn');
    const cancelLogoutBtn = document.getElementById('cancel-logout-btn');
    const logoutConfirmationDialog = document.getElementById('logout-confirmation-dialog-overlay');
    const logoutCloseBtn = document.querySelector('#logout-confirmation-dialog-overlay .confirmation-close-btn');

    if (confirmLogoutBtn) {
        confirmLogoutBtn.addEventListener('click', async () => {
            closeLogoutConfirmationDialog();
            try { 
                if (auth) {
                    await auth.signOut(); 
                }
                closeDrawer(); 
                showToast("âœ… Successfully Logged Out!", 'success');
            } catch (error) { 
                showToast("Logout failed: " + error.message, 'error'); 
            }
        });
    }
    if (cancelLogoutBtn) {
        cancelLogoutBtn.addEventListener('click', closeLogoutConfirmationDialog);
    }
    if (logoutConfirmationDialog) {
        logoutConfirmationDialog.addEventListener('click', (e) => {
            if (e.target.id === 'logout-confirmation-dialog-overlay') {
                closeLogoutConfirmationDialog();
            }
        });
    }
    if (logoutCloseBtn) {
        logoutCloseBtn.addEventListener('click', closeLogoutConfirmationDialog);
    }

    // Delete Account Confirmation Dialog Event Listeners
    const contactAdminBtn = document.getElementById('contact-admin-btn');
    const cancelDeleteAccountBtn = document.getElementById('cancel-delete-account-btn');
    const deleteAccountConfirmationDialog = document.getElementById('delete-account-confirmation-dialog-overlay');
    const deleteAccountCloseBtn = document.querySelector('#delete-account-confirmation-dialog-overlay .confirmation-close-btn');

    if (contactAdminBtn) {
        contactAdminBtn.addEventListener('click', () => {
            closeDeleteAccountConfirmationDialog();
            showToast("Please contact admin at: admin@merotopup.com", 'info');
        });
    }
    if (cancelDeleteAccountBtn) {
        cancelDeleteAccountBtn.addEventListener('click', closeDeleteAccountConfirmationDialog);
    }
    if (deleteAccountConfirmationDialog) {
        deleteAccountConfirmationDialog.addEventListener('click', (e) => {
            if (e.target.id === 'delete-account-confirmation-dialog-overlay') {
                closeDeleteAccountConfirmationDialog();
            }
        });
    }
    if (deleteAccountCloseBtn) {
        deleteAccountCloseBtn.addEventListener('click', closeDeleteAccountConfirmationDialog);
    }

    // Reseller Admin Button Event Listener
    const resellerAdminBtn = document.getElementById('reseller-admin-btn');
    if (resellerAdminBtn) {
        resellerAdminBtn.addEventListener('click', redirectToResellerAdmin);
    }

    // Profile Popup Event Listeners
    const headerProfileImg = document.getElementById('header-profile-img');
    const profilePopupCloseBtn = document.querySelector('.profile-popup-close-btn');
    const profilePopupOverlay = document.getElementById('profile-popup-overlay');

    if (headerProfileImg) {
        headerProfileImg.addEventListener('click', showProfilePopup);
    }
    if (profilePopupCloseBtn) {
        profilePopupCloseBtn.addEventListener('click', closeProfilePopup);
    }
    if (profilePopupOverlay) {
        profilePopupOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'profile-popup-overlay') {
                closeProfilePopup();
            }
        });
    }

    // Fix for "How to add money?" link
    const howToAddMoneyLink = document.getElementById('how-to-add-money-link');
    if (howToAddMoneyLink) {
        howToAddMoneyLink.addEventListener('click', function(e) {
            if (!isUserLoggedIn) {
                e.preventDefault();
                openAuthModal();
            }
            // If logged in, the natural link behavior will occur (redirect to YouTube)
        });
    }

    // Close drawer when menu items are clicked
    document.querySelectorAll('.profile-drawer .menu-button').forEach(button => {
        button.addEventListener('click', closeDrawer);
    });

    // Auth state change listener
    if (auth) {
        auth.onAuthStateChanged(user => {
            if (user) {
                isUserLoggedIn = true;
                loadUserData(user.uid);
                
                // Load leaderboard when user is logged in
                loadTopUsers();
                
                setTimeout(() => {
                    showResellerDialog();
                }, 2000);
            } else {
                resetUIForLoggedOutUser();
                
                // Load leaderboard for guests too
                loadTopUsers();
                
                setTimeout(() => {
                    showResellerDialog();
                }, 2000);
            }
        });
    } else {
        console.error("Firebase auth not available");
        resetUIForLoggedOutUser();
        loadTopUsers();
    }

    // Auth form handlers
    const signupActionBtn = document.getElementById('signup-action-btn');
    const loginActionBtn = document.getElementById('login-action-btn');
    
    if (signupActionBtn) {
        signupActionBtn.addEventListener('click', handleSignUp);
    }
    if (loginActionBtn) {
        loginActionBtn.addEventListener('click', handleLogin);
    }
    
    // Avatar upload handling
    const authAvatarInput = document.getElementById('auth-avatar-input');
    const authAvatarPreview = document.getElementById('auth-avatar-preview');
    const authAvatarIcon = document.getElementById('auth-avatar-icon');
    
    if(authAvatarInput) {
        authAvatarInput.addEventListener('change', async function() {
            const file = this.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    if (authAvatarPreview) {
                        authAvatarPreview.src = e.target.result;
                        authAvatarPreview.style.display = 'block';
                    }
                    if(authAvatarIcon) authAvatarIcon.style.display = 'none';
                };
                reader.readAsDataURL(file);

                try {
                    const compressedBlob = await compressImage(file);
                    startProfilePicUpload(compressedBlob);
                } catch (error) {
                    showToast("Error processing photo. Please try a different image.", 'error');
                    console.error("Compression Error:", error);
                    profilePicURL = null;
                    isUploading = false;
                    if (currentUpload) currentUpload.cancel();
                }

            } else {
                if (authAvatarPreview) {
                    authAvatarPreview.src = '';
                    authAvatarPreview.style.display = 'none';
                }
                if(authAvatarIcon) authAvatarIcon.style.display = 'block';
                profilePicURL = null;
                isUploading = false;
                if (currentUpload) currentUpload.cancel();
            }
        });
    }

    // Forgot password handling
    const forgotLink = document.getElementById('auth-forgot-password-link');
    const forgotModal = document.getElementById('forgot-modal');
    const resetCancelBtn = document.getElementById('reset-cancel-btn');
    const resetSendBtn = document.getElementById('reset-send-btn');
    const loginEmailInput = document.getElementById('login-email-input');

    if (forgotLink) {
        forgotLink.addEventListener('click', (e) => {
            e.preventDefault();
            if (forgotModal) {
                forgotModal.style.display = 'flex';
            }
            const resetEmail = document.getElementById('reset-email');
            if (resetEmail && loginEmailInput) {
                resetEmail.value = loginEmailInput.value.trim();
            }
        });
    }

    if (resetCancelBtn) {
        resetCancelBtn.addEventListener('click', () => {
            if (forgotModal) {
                forgotModal.style.display = 'none';
            }
        });
    }

    if (resetSendBtn) {
        resetSendBtn.addEventListener('click', handlePasswordReset);
    }
    
    // Language switching
    const authLangSwitch = document.getElementById('auth-lang-switch');
    const authLangSwitch2 = document.getElementById('auth-lang-switch2');
    
    if(authLangSwitch) {
        authLangSwitch.addEventListener('change', e => {
            setLanguage(e.target.value); 
            if (authLangSwitch2) authLangSwitch2.value = e.target.value;
        });
    }
    if(authLangSwitch2) {
        authLangSwitch2.addEventListener('change', e => {
            setLanguage(e.target.value);
            if (authLangSwitch) authLangSwitch.value = e.target.value;
        });
    }
    
    // Setup terms and conditions
    setupTermsAndConditions();
    
    // Action required buttons
    document.querySelectorAll('.action-required-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            if (!isUserLoggedIn) {
                e.preventDefault(); 
                e.stopPropagation(); 
                openAuthModal();
                return;
            }
            
            if (this.classList.contains('nav-item')) {
                // Navigation handled separately
            } else if (this.dataset.action) {
                handleAction(this.dataset.action);
            }
            
            if (this.id === 'go-to-wallet-btn') {
                const paymentNavItem = document.querySelector('.nav-item[data-page="page-payment"]');
                if (paymentNavItem) paymentNavItem.click();
            }
            
            if (this.classList.contains('copy-icon')) {
                const accountText = document.getElementById('account-number');
                if (accountText) {
                    navigator.clipboard.writeText(accountText.textContent).then(() => {
                        const originalHTML = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i>';
                        setTimeout(() => { this.innerHTML = originalHTML; }, 2000);
                    });
                }
            }
            
            if (this.id === 'update-profile-btn') {
                updateUserProfile();
            }
            
            if (this.id === 'request-topup-btn') {
                requestTopup();
            }
        });
    });
    
    // Open auth modal buttons
    document.querySelectorAll('.open-auth-modal-btn').forEach(btn => {
        btn.addEventListener('click', openAuthModal);
    });
    
    // Auth modal overlay click to close
    const authModalOverlay = document.getElementById('auth-modal-overlay');
    if (authModalOverlay) {
        authModalOverlay.addEventListener('click', (e) => {
            if (e.target.id === 'auth-modal-overlay') {
                closeAuthModal();
            }
        });
    }
    
    // Auth toggle button (login/logout)
    const authToggleBtn = document.getElementById('auth-toggle-btn');
    if (authToggleBtn) {
        authToggleBtn.addEventListener('click', async () => {
            if (isUserLoggedIn) {
                showLogoutConfirmationDialog();
            } else {
                closeDrawer();
                openAuthModal();
            }
        });
    }

    // Topup card handlers
    const uidCard = document.querySelector('[data-action="topup_uid"]'); 
    const pubgCard = document.getElementById('pubg-card'); 

    function handleTopupClick(redirectPage) {
        if (!isUserLoggedIn) {
            openAuthModal();
            return;
        }
        if (!currentUserId || !currentUserName) {
            alert("User data not loaded yet. Please wait a moment.");
            return;
        }

        const userData = {
            uid: currentUserId,
            name: currentUserName,
            number: currentUserNumber,
            email: auth.currentUser?.email || "",
            balance: document.getElementById('user-balance')?.textContent || "0.00",
            profilePic: document.getElementById('header-profile-img')?.src || ""
        };

        sessionStorage.setItem("UC_USER_DATA", JSON.stringify(userData));
        window.location.href = redirectPage;
    }

    if(uidCard){ 
        uidCard.addEventListener('click', (e) => { 
            e.preventDefault(); 
            handleTopupClick("diamond_list.html"); 
        }); 
    }
    if(pubgCard){ 
        pubgCard.addEventListener('click', (e) => { 
            e.preventDefault(); 
            handleTopupClick("uc_list.html"); 
        }); 
    }

    // Go to wallet button
    const goToWalletBtn = document.getElementById('go-to-wallet-btn');
    if (goToWalletBtn) {
        goToWalletBtn.addEventListener('click', () => {
            if (!isUserLoggedIn) { 
                openAuthModal(); 
                return; 
            }
            const paymentNavItem = document.querySelector('.nav-item[data-page="page-payment"]');
            if (paymentNavItem) paymentNavItem.click();
        });
    }

    // Wallet selection
    const walletItems = document.querySelectorAll('.payment-item');
    const bankSelection = document.getElementById('bank-selection');
    const bankSelectDropdown = document.getElementById('bank-select-dropdown');
    
    walletItems.forEach(item => {
        item.addEventListener('click', function() {
            if (!isUserLoggedIn) { 
                openAuthModal(); 
                return; 
            }
            
            walletItems.forEach(i => {
                i.classList.remove('selected');
                const checkIcon = i.querySelector('.fa-check-circle');
                if (checkIcon) checkIcon.style.opacity = '0';
            });
            this.classList.add('selected');
            const checkIcon = this.querySelector('.fa-check-circle');
            if (checkIcon) checkIcon.style.opacity = '1';
            selectedWallet = this.dataset.wallet;
            if (requestTopupBtn) requestTopupBtn.classList.add('active');
            
            if (selectedWallet === 'Bank') {
                if (bankSelection) bankSelection.style.display = 'block';
                
                if (!selectedBank && bankSelectDropdown && bankSelectDropdown.options.length > 1) {
                    bankSelectDropdown.value = bankSelectDropdown.options[1].value; 
                    selectedBank = bankSelectDropdown.value;
                } else if (selectedBank && bankSelectDropdown) {
                     bankSelectDropdown.value = selectedBank;
                } else if (bankSelectDropdown) {
                     bankSelectDropdown.value = '';
                }
            } else {
                if (bankSelection) bankSelection.style.display = 'none';
                selectedBank = null;
            }
        });
    });
    
    if(bankSelectDropdown) {
        bankSelectDropdown.addEventListener('change', function() {
            selectedBank = this.value; 
            console.log("Selected Bank:", selectedBank);
        });
    }

    // QR code icons in wallet selection
    document.querySelectorAll('.qr-icon').forEach(icon => {
        icon.addEventListener('click', function(e) {
            e.stopPropagation();
            const wallet = this.dataset.wallet;
            showWalletQR(wallet);
        });
    });

    // Request topup button
    if (requestTopupBtn) {
        requestTopupBtn.addEventListener('click', requestTopup);
    }

    // Update profile button
    const updateProfileBtn = document.getElementById('update-profile-btn');
    if (updateProfileBtn) {
        updateProfileBtn.addEventListener('click', updateUserProfile);
    }

    // Profile menu buttons
    document.querySelectorAll('#page-profile .menu-button').forEach(button => {
        button.addEventListener('click', function() {
            handleAction(this.dataset.action);
        });
    });
    
    // Action items and product cards
    document.querySelectorAll('.action-item:not(.action-required-btn), .product-card:not(.action-required-btn)').forEach(button => {
        button.addEventListener('click', function() {
            const actionType = this.dataset.action;
            if (actionType) {
                handleAction(actionType);
            }
        });
    });

    // Menu item handlers
    const notificationIcon = document.getElementById('notification-icon');
    const transactionsMenu = document.getElementById('transactions-menu');
    const helpSupportMenu = document.getElementById('help-support-menu');
    const aboutMenu = document.getElementById('about-menu');
    const privacyMenu = document.getElementById('privacy-menu');
    const termsMenu = document.getElementById('terms-menu');
    const deleteAccountBtn = document.getElementById('delete-account-btn');

    if (notificationIcon) {
        notificationIcon.addEventListener('click', redirectToNotification);
    }
    if (transactionsMenu) {
        transactionsMenu.addEventListener('click', redirectToTransactionHistory);
    }
    if (helpSupportMenu) {
        helpSupportMenu.addEventListener('click', redirectToHelpSupport);
    }
    if (aboutMenu) {
        aboutMenu.addEventListener('click', redirectToAbout);
    }
    if (privacyMenu) {
        privacyMenu.addEventListener('click', redirectToPrivacyPolicy);
    }
    if (termsMenu) {
        termsMenu.addEventListener('click', redirectToTermsOfService);
    }
    if (deleteAccountBtn) {
        deleteAccountBtn.addEventListener('click', showDeleteAccountConfirmationDialog);
    }

    // Drawer functionality
    const openDrawerBtn = document.getElementById('open-drawer-btn');
    const profileDrawer = document.getElementById('profile-drawer');
    const drawerOverlay = document.getElementById('drawer-overlay');
    
    if (openDrawerBtn) {
        openDrawerBtn.addEventListener('click', openDrawer);
    }
    if (drawerOverlay) {
        drawerOverlay.addEventListener('click', closeDrawer);
    }

    // Navigation
    const navItems = document.querySelectorAll('.nav-item');
    const pages = document.querySelectorAll('.page');
    const pageTitle = document.getElementById('page-title');
    const titleMap = { 
        'page-home': 'Mero Topup', 
        'page-order': 'My Orders', 
        'page-payment': 'Wallet', 
        'page-profile': 'My Account' 
    }; 
    
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            const targetPageId = this.dataset.page;
            const targetPage = document.getElementById(targetPageId);

            if (!isUserLoggedIn && (targetPageId !== 'page-home')) {
                openAuthModal();
                return; 
            }
            
            if (targetPage) {
                pages.forEach(p => p.classList.remove('active'));
                targetPage.classList.add('active');
                navItems.forEach(n => n.classList.remove('active'));
                this.classList.add('active');
                if (pageTitle) {
                    pageTitle.textContent = titleMap[targetPageId] || 'App Name';
                }
                
                resetPageScroll();
                
                if (targetPageId === 'page-payment') {
                    if (selectedWallet && requestTopupBtn) {
                        requestTopupBtn.classList.add('active');
                    } else if (requestTopupBtn) {
                        requestTopupBtn.classList.remove('active');
                    }
                }
                
                if (targetPageId === 'page-order' && currentUserId) {
                    loadOrders(currentUserId);
                }
            }
        });
    });

    // Balance visibility toggle
    const visibilityIcon = document.getElementById('visibility-toggle');
    const balanceAmount = document.getElementById('user-balance');
    let balanceVisible = true;
    let actualBalance = balanceAmount ? balanceAmount.textContent : "0.00"; 
    
    if (visibilityIcon && balanceAmount) {
        visibilityIcon.addEventListener('click', function() {
            if (!isUserLoggedIn) { 
                openAuthModal(); 
                return; 
            }
            if(balanceAmount.textContent === '...' || balanceAmount.textContent === 'Loading...' || balanceAmount.textContent === 'Error!' || balanceAmount.textContent === 'Login') return;
            balanceVisible = !balanceVisible;
            if (balanceVisible) {
                balanceAmount.textContent = actualBalance;
                this.innerHTML = '<i class="fas fa-eye"></i>';
            } else {
                actualBalance = balanceAmount.textContent; 
                balanceAmount.textContent = '****';
                this.innerHTML = '<i class="fas fa-eye-slash"></i>';
            }
        });
    }

    // QR code modal
    const openQrModalBtn = document.getElementById('open-qr-modal-btn');
    const closeQrModalBtn = document.getElementById('close-qr-modal-btn');
    const qrModalOverlay = document.getElementById('qr-modal-overlay');
    
    if (openQrModalBtn) {
        openQrModalBtn.addEventListener('click', function() {
            if (!isUserLoggedIn) { 
                openAuthModal(); 
                return; 
            }
            if (currentUserId) {
                generateQRCode(currentUserId);
            }
        });
    }

    if (closeQrModalBtn) {
        closeQrModalBtn.addEventListener('click', closeQrModal);
    }
    if (qrModalOverlay) {
        qrModalOverlay.addEventListener('click', (e) => { 
            if (e.target.id === 'qr-modal-overlay') { 
                closeQrModal(); 
            } 
        });
    }

    // Wallet QR modal
    const closeWalletQrModalBtn = document.getElementById('close-wallet-qr-modal-btn');
    const walletQrModalOverlay = document.getElementById('wallet-qr-modal-overlay');
    
    if (closeWalletQrModalBtn) {
        closeWalletQrModalBtn.addEventListener('click', closeWalletQrModal);
    }
    if (walletQrModalOverlay) {
        walletQrModalOverlay.addEventListener('click', (e) => { 
            if (e.target.id === 'wallet-qr-modal-overlay') { 
                closeWalletQrModal(); 
            } 
        });
    }

    // Transaction info modal
    const openInfoModalBtn = document.getElementById('open-info-modal-btn');
    const closeInfoModalBtn = document.getElementById('close-info-modal-btn');
    const transactionInfoModalOverlay = document.getElementById('transaction-info-modal-overlay');
    
    if (openInfoModalBtn) {
        openInfoModalBtn.addEventListener('click', openTransactionInfoModal);
    }
    if (closeInfoModalBtn) {
        closeInfoModalBtn.addEventListener('click', closeTransactionInfoModal);
    }
    if (transactionInfoModalOverlay) {
        transactionInfoModalOverlay.addEventListener('click', (e) => { 
            if (e.target.id === 'transaction-info-modal-overlay') { 
                closeTransactionInfoModal(); 
            } 
        });
    }

    console.log("App initialization completed");
});
</script>
</body>
</html>